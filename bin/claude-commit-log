#!/usr/bin/env bash
# ============================================================================
# claude-commit-log - Claude Code PostToolUse hook for git commit logging
# ============================================================================
# stdinã‹ã‚‰PostToolUseã®JSONã‚’èª­ã¿å–ã‚Šã€git commitã‚’æ¤œå‡ºã—ã¦
# Obsidianãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ¼ãƒˆã®ğŸ¤– Commitsã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¨˜éŒ²ã™ã‚‹ã€‚

set -euo pipefail

TH="/Users/s32943/gh/github.com/ryosukesuto/dotfiles/bin/th"

# stdinã‹ã‚‰JSONèª­ã¿å–ã‚Š
input=$(cat)

# git commitã‚³ãƒãƒ³ãƒ‰ã‹åˆ¤å®šï¼ˆé«˜é€Ÿãƒ•ã‚£ãƒ«ã‚¿ï¼‰
command=$(echo "$input" | jq -r '.tool_input.command // empty' 2>/dev/null)
if [[ -z "$command" ]] || [[ "$command" != *"git commit"* ]]; then
    exit 0
fi

# tool_responseã‹ã‚‰æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º
# tool_responseã¯æ–‡å­—åˆ—ã¾ãŸã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆstdout/stderrãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰ã®å ´åˆãŒã‚ã‚‹
response=$(echo "$input" | jq -r '
    if (.tool_response | type) == "string" then
        .tool_response
    elif (.tool_response | type) == "object" then
        [.tool_response.stdout // "", .tool_response.stderr // ""] | join("\n")
    else
        ""
    end
' 2>/dev/null)

if [[ -z "$response" ]]; then
    exit 0
fi

# æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³: [branch hash] commit message
# ä¾‹: [main abc1234] feat: add feature
if ! echo "$response" | grep -qE '^\[.+ [0-9a-f]+\]'; then
    exit 0
fi

# ãƒ–ãƒ©ãƒ³ãƒåã¨ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ½å‡º
branch=$(echo "$response" | grep -oE '^\[[^ ]+ ' | head -1 | tr -d '[ ')
commit_line=$(echo "$response" | grep -E '^\[.+ [0-9a-f]+\]' | head -1)
commit_msg=$(echo "$commit_line" | sed -E 's/^\[[^]]+\] //')

# å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’æŠ½å‡ºï¼ˆ"N files changed" or "N file changed"ï¼‰
file_count=$(echo "$response" | grep -oE '[0-9]+ files? changed' | grep -oE '[0-9]+' || echo "")

# ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªã‚’æ§‹ç¯‰
if [[ -n "$file_count" ]]; then
    entry="[${branch}] ${commit_msg} (${file_count} files)"
else
    entry="[${branch}] ${commit_msg}"
fi

# ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ¼ãƒˆã«è¨˜éŒ²
"$TH" -s "ğŸ¤– Commits" "$entry" || true
