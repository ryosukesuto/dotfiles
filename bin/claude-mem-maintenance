#!/usr/bin/env bash
# ============================================================================
# claude-mem-maintenance - claude-memデータの定期メンテナンス
# ============================================================================
# 7日間隔で実行: ログローテーション、SQLite VACUUM、統計レポート出力。
# Claude Code の UserPromptSubmit hook から呼び出される想定。
# マーカーファイルで実行間隔を制御し、高速パス（~10ms）で不要な実行をスキップ。

set -euo pipefail

CLAUDE_MEM_DIR="$HOME/.claude-mem"
DB_FILE="$CLAUDE_MEM_DIR/claude-mem.db"
LOG_DIR="$CLAUDE_MEM_DIR/logs"
VECTOR_DB_DIR="$CLAUDE_MEM_DIR/vector-db"
MARKER_FILE="$CLAUDE_MEM_DIR/.last-maintenance"
INTERVAL_DAYS=7
LOG_RETENTION_DAYS=7

# claude-memディレクトリが存在しない場合は何もしない
if [[ ! -d "$CLAUDE_MEM_DIR" ]]; then
    exit 0
fi

# マーカーファイルの日付を確認（高速パス）
if [[ -f "$MARKER_FILE" ]]; then
    if [[ "$(uname)" == "Darwin" ]]; then
        last_run=$(stat -f %m "$MARKER_FILE")
    else
        last_run=$(stat -c %Y "$MARKER_FILE")
    fi
    now=$(date +%s)
    elapsed=$(( now - last_run ))
    threshold=$(( INTERVAL_DAYS * 86400 ))

    if [[ $elapsed -lt $threshold ]]; then
        exit 0
    fi
fi

# --- メンテナンス実行 ---

echo "claude-mem maintenance: 開始"

# 1. ログローテーション
deleted_count=0
if [[ -d "$LOG_DIR" ]]; then
    while IFS= read -r -d '' logfile; do
        rm -f "$logfile"
        (( deleted_count++ )) || true
    done < <(find "$LOG_DIR" -name "claude-mem-*.log" -mtime +"$LOG_RETENTION_DAYS" -print0 2>/dev/null) || true
fi
echo "  ログローテーション: ${deleted_count}件削除（${LOG_RETENTION_DAYS}日超）"

# 2. SQLite VACUUM
if [[ -f "$DB_FILE" ]]; then
    db_size_before=$(wc -c < "$DB_FILE" | tr -d ' ')
    sqlite3 "$DB_FILE" "VACUUM;"
    db_size_after=$(wc -c < "$DB_FILE" | tr -d ' ')
    reclaimed=$(( db_size_before - db_size_after ))
    echo "  VACUUM: $(( reclaimed / 1024 ))KB回収"
fi

# 3. マーカーファイル更新
touch "$MARKER_FILE"

# 4. 統計レポート
echo "  --- 統計 ---"

if [[ -f "$DB_FILE" ]]; then
    obs_count=$(sqlite3 "$DB_FILE" "SELECT COUNT(*) FROM observations;" 2>/dev/null || echo "N/A")
    echo "  観測レコード: ${obs_count}件"
fi

# サイズ集計（human-readable）
format_size() {
    local bytes=$1
    if [[ $bytes -ge 1073741824 ]]; then
        echo "$(( bytes / 1073741824 ))GB"
    elif [[ $bytes -ge 1048576 ]]; then
        echo "$(( bytes / 1048576 ))MB"
    elif [[ $bytes -ge 1024 ]]; then
        echo "$(( bytes / 1024 ))KB"
    else
        echo "${bytes}B"
    fi
}

if [[ -f "$DB_FILE" ]]; then
    db_total=0
    for f in "$DB_FILE" "$DB_FILE-shm" "$DB_FILE-wal"; do
        [[ -f "$f" ]] && db_total=$(( db_total + $(wc -c < "$f" | tr -d ' ') ))
    done
    echo "  DB: $(format_size $db_total)"
fi

if [[ -d "$LOG_DIR" ]]; then
    log_bytes=$(find "$LOG_DIR" -type f -name "*.log" -print0 2>/dev/null | xargs -0 wc -c 2>/dev/null | tail -1 | awk '{print $1}')
    log_bytes=${log_bytes:-0}
    echo "  Logs: $(format_size $log_bytes)"
fi

if [[ -d "$VECTOR_DB_DIR" ]]; then
    # macOS du lacks -b; use -k and convert
    vector_kb=$(du -sk "$VECTOR_DB_DIR" 2>/dev/null | cut -f1)
    vector_bytes=$(( ${vector_kb:-0} * 1024 ))
    echo "  VectorDB: $(format_size $vector_bytes)"
fi

echo "claude-mem maintenance: 完了"
