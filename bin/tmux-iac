#!/bin/bash
# tmux-iac - IaC作業用の固定レイアウトを起動
#
# レイアウト:
# +------------------+------------+
# |                  | PR監視     |
# |    作業用        | (checks)   |
# |   (メイン)       +------------+
# |                  | Lint実行   |
# |                  |            |
# +------------------+------------+

set -euo pipefail

SESSION_NAME="${1:-iac}"
PR_NUMBER="${2:-}"

# 既存セッションがあればアタッチ
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo "Attaching to existing session: $SESSION_NAME"
    tmux attach-session -t "$SESSION_NAME"
    exit 0
fi

# 新規セッション作成
tmux new-session -d -s "$SESSION_NAME" -n "work"

# メインペイン（左、70%幅）
tmux select-pane -t "$SESSION_NAME:1.1"

# 右側に分割（30%幅）
tmux split-window -h -p 30 -t "$SESSION_NAME:1.1"

# 右側を上下に分割
tmux split-window -v -p 50 -t "$SESSION_NAME:1.2"

# 各ペインの初期コマンド
# 右上: PR監視用（PR番号があれば監視開始）
if [[ -n "$PR_NUMBER" ]]; then
    tmux send-keys -t "$SESSION_NAME:1.2" "watch -n 30 'gh pr checks $PR_NUMBER 2>/dev/null; echo; echo \"--- Comments ---\"; gh pr view $PR_NUMBER --comments 2>/dev/null | tail -50'" Enter
else
    tmux send-keys -t "$SESSION_NAME:1.2" "echo 'PR監視: watch -n 30 gh pr checks <PR>'" Enter
fi

# 右下: Lint用
tmux send-keys -t "$SESSION_NAME:1.3" "echo 'Lint: tflint --recursive && trivy config .'" Enter

# 左ペイン（メイン）にフォーカス
tmux select-pane -t "$SESSION_NAME:1.1"

# アタッチ
tmux attach-session -t "$SESSION_NAME"
