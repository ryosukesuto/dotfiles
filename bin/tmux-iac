#!/bin/bash
# tmux-iac - IaC作業用の固定レイアウトを起動
#
# レイアウト（2カラム）:
# +---------------------+---------------------+
# |                     |                     |
# |    Claude Code      |       Codex         |
# |      (実装)         |     (レビュー)      |
# |                     |                     |
# +---------------------+---------------------+
#
# ポップアップ（prefix +）:
#   d: git diff
#   p: gh pr diff
#   c: ctx-iac → clipboard

set -euo pipefail

SESSION_NAME="${1:-iac}"

# 既存セッションがあればアタッチ
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo "Attaching to existing session: $SESSION_NAME"
    tmux attach-session -t "$SESSION_NAME"
    exit 0
fi

# 新規セッション作成
tmux new-session -d -s "$SESSION_NAME" -n "work"

# 左ペイン: Claude Code用（50%幅）
tmux select-pane -t "$SESSION_NAME:1.1"
tmux send-keys -t "$SESSION_NAME:1.1" "echo 'Claude Code (実装)'" Enter

# 右ペイン: Codex用（50%幅）
tmux split-window -h -p 50 -t "$SESSION_NAME:1.1"
tmux send-keys -t "$SESSION_NAME:1.2" "echo 'Codex (レビュー)'" Enter
tmux send-keys -t "$SESSION_NAME:1.2" "echo 'ctx-iac --pr | codex exec  # PRレビュー'" Enter
tmux send-keys -t "$SESSION_NAME:1.2" "echo 'ctx-iac --local | codex exec  # ローカルレビュー'" Enter

# 左ペイン（Claude Code）にフォーカス
tmux select-pane -t "$SESSION_NAME:1.1"

# アタッチ
tmux attach-session -t "$SESSION_NAME"
