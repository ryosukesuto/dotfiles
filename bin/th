#!/usr/bin/env bash
# ============================================================================
# th - Obsidianãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ¼ãƒˆè¨˜éŒ²ãƒ„ãƒ¼ãƒ«
# ============================================================================
# ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ç‰ˆã®thé–¢æ•°ã€‚source ~/.zshrcãªã—ã§å®Ÿè¡Œå¯èƒ½ã€‚

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
section="ğŸ“ ãƒ¡ãƒ¢"
while [[ $# -gt 0 ]]; do
    case "$1" in
        -s|--section)
            section="$2"
            shift 2
            ;;
        -*)
            echo "ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1" >&2
            exit 1
            ;;
        *)
            break
            ;;
    esac
done

# ä½¿ç”¨æ–¹æ³•ã®ç¢ºèª
if [[ -z "$1" ]]; then
    echo "ä½¿ç”¨æ–¹æ³•: th [-s ã‚»ã‚¯ã‚·ãƒ§ãƒ³] <ãƒ¡ãƒ¢å†…å®¹>"
    exit 1
fi

# è¨­å®š
vault_path="$HOME/gh/github.com/ryosukesuto/obsidian-notes"
today=$(date +%Y-%m-%d)
daily_note="$vault_path/${today}_daily.md"
timestamp=$(date "+%Y/%m/%d %H:%M:%S")
section_header="## ${section}"

# Vaultãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª
if [[ ! -d "$vault_path" ]]; then
    echo "ã‚¨ãƒ©ãƒ¼: Obsidian vaultãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $vault_path"
    exit 1
fi

# ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ¼ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
if [[ ! -f "$daily_note" ]]; then
    echo "# ${today}" > "$daily_note"
    echo "" >> "$daily_note"
    echo "${section_header}" >> "$daily_note"
fi

# æŒ‡å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯è¿½åŠ 
if ! grep -qF "${section_header}" "$daily_note"; then
    echo "" >> "$daily_note"
    echo "${section_header}" >> "$daily_note"
fi

# æ–°ã—ã„ãƒ¡ãƒ¢ã‚’è¿½åŠ 
new_memo="- ${timestamp}: $*"
temp_file="${daily_note}.tmp"
last_entry_line=0
line_num=0
in_section=0

# æŒ‡å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æœ€å¾Œã®ã‚¨ãƒ³ãƒˆãƒªè¡Œã‚’è¦‹ã¤ã‘ã‚‹
while IFS= read -r line; do
    ((line_num++))
    if [[ "$line" == "${section_header}" ]]; then
        in_section=1
    elif [[ $in_section -eq 1 ]]; then
        if [[ "$line" =~ ^-[[:space:]] ]]; then
            last_entry_line=$line_num
        elif [[ "$line" =~ ^##[[:space:]] ]] || [[ "$line" == "---" ]]; then
            in_section=0
        fi
    fi
done < "$daily_note"

# ãƒ¡ãƒ¢ã‚’é©åˆ‡ãªä½ç½®ã«æŒ¿å…¥
if [[ $last_entry_line -gt 0 ]]; then
    awk -v line="$last_entry_line" -v memo="$new_memo" 'NR==line{print; print memo; next} 1' "$daily_note" > "$temp_file"
else
    awk -v header="${section_header}" -v memo="$new_memo" '$0==header{print; print memo; next} 1' "$daily_note" > "$temp_file"
fi

/bin/mv -f "$temp_file" "$daily_note"
echo "âœ… ãƒ¡ãƒ¢ã‚’è¿½åŠ ã—ã¾ã—ãŸ: $*"
