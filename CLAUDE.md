# CLAUDE.md

このファイルは、Claude Code (claude.ai/code) がこのリポジトリのコードを扱う際のガイダンスを提供します。

## リポジトリ概要

これは個人用の設定ファイルを管理する包括的なdotfilesリポジトリです。Zsh、Git、SSH、tmux、Vim、AWS CLI、GitHub CLIなどのモダンな開発ツールの設定ファイルが整理されて含まれています。

## リポジトリ構成

リポジトリは以下のように論理的なディレクトリに整理されています：

- `zsh/` - モジュール化されたZsh設定ファイル（番号付きで読み込み順序を制御）
  - `00-core.zsh` - コアシェル設定と履歴管理
  - `10-completion.zsh` - 最小限の補完システム設定
  - `20-path.zsh` - セキュアで効率的なPATH管理（診断機能付き）
  - `30-aliases.zsh` - カテゴリ別に体系化されたエイリアス定義
  - `40-functions.zsh` - セキュアな遅延読み込み機構とコア関数
  - `50-tools.zsh` - miseによる統一バージョンマネージャー初期化
  - `60-prompt.zsh` - モジュラー化されたプロンプト設定（メインファイル）
  - `90-local.zsh` - ローカル環境変数とマシン固有の設定
  - `lib/` - **新設** プロンプト機能のモジュラーライブラリ
    - `git-prompt.zsh` - Git情報表示とキャッシュ機能
    - `env-prompt.zsh` - 開発環境情報表示（Python/AWS/Terraform）
    - `timer-prompt.zsh` - コマンド実行時間測定機能
  - `functions/` - 遅延読み込みされる関数モジュール
    - `aws-bastion.zsh` - AWS SSM Session Managerユーティリティ
    - `obsidian-claude.zsh` - Obsidian-Claude連携関数
    - `diagnostics.zsh` - システム診断ユーティリティ
    - `extract.zsh` - アーカイブ展開ユーティリティ
    - `gemini-search.zsh` - Gemini API検索関数（オプション）
- `git/` - エイリアスと拡張設定を含むGit設定
- `ssh/` - SSH設定と管理ユーティリティ
- `tmux/` - ターミナルマルチプレクサ設定
- `vim/` - プラグイン管理を含むVimエディタ設定
- `aws/` - AWS CLI設定テンプレート（セキュア、認証情報なし）
- `config/` - アプリケーション固有の設定（GitHub CLI、Claude Codeなど）
  - `config/claude/commands/` - ユーザー固有のClaude Codeカスタムコマンド
- `.zshrc` - モジュラーファイルをソースするメインZshエントリポイント
- `.zprofile` - 環境セットアップ用のZshプロファイル

## 主要なツールと技術

このセットアップで使用されている、設定が必要な可能性のあるツール：

- **シェル**: ディレクトリナビゲーション用のカスタムpeco-src関数を持つZsh
- **バージョンマネージャー**: mise（Python、Ruby、Terraform、Node.jsなど統一管理）
- **開発ツール**: Go、Terraform、DBT（data build tool）
- **リポジトリ管理**: ghq（Gitリポジトリを~/src配下に整理）
- **パッケージマネージャー**: Homebrew（macOS）
- **クラウドアクセス**: Bastionサーバー接続用のAWS SSM Session Manager

## 一般的なタスク

このdotfilesリポジトリで作業する際：

1. **インストール**: `./install.sh`を使用してリポジトリからホームディレクトリへのシンボリックリンクを作成
2. **更新**: リポジトリ内のファイルを変更すると、シンボリックリンク経由で即座に反映される
3. **新しいマシンのセットアップ**: リポジトリをクローンしてインストールスクリプトを実行し、完全な環境をセットアップ
4. **セキュリティ**: 機密設定にはテンプレートファイルを使用（AWSなど）
5. **ローカルカスタマイズ**: gitで追跡されないマシン固有の設定には`.local`ファイルを使用
6. **関数の追加**: 大きなまたはめったに使用されない関数は`zsh/functions/`ディレクトリに配置して遅延読み込み
7. **パフォーマンス**: シェルの起動は遅延読み込みと最小限の初期設定により最適化されている

## アーキテクチャノート

### 開発環境
- **言語**: Python、Ruby、Terraform（miseで統一管理）
- **クラウドプラットフォーム**: AWS、Google Cloud Platform
- **リポジトリ管理**: ghqがGitリポジトリを`~/src`配下に整理
- **プロジェクトナビゲーション**: クイックディレクトリ切り替え用のpeco-src/fzf-src（Ctrl+GまたはCtrl+]）

### 主要機能
- **最小限のZsh設定**: 必要最小限の機能のみで高速起動
- **スマート補完**: 複雑な設定なしの基本的なタブ補完
- **遅延読み込み**: パフォーマンスのために関数とツールをオンデマンドで読み込み
- **AWS統合**: Bastionアクセス用のSSM Session Manager
- **クリーンなプロンプト**: 現在のディレクトリ、Gitステータス、アクティブな環境を表示

### パフォーマンス最適化とセキュリティ
- **モジュラー設計**: プロンプト機能を`zsh/lib/`配下の独立モジュールに分離
- **セキュアなPATH管理**: 信頼できるパスのみを効率的に追加、セキュリティ検証付き
- **遅延読み込み機構**: ファイル検証とパフォーマンス測定を統合したセキュアな関数読み込み
- **統一ツール管理**: miseによる複数言語バージョン管理の統一
- **キャッシュシステム**: Git情報とプロンプト表示の効率的なキャッシング

## カスタムコマンド

このリポジトリで一般的なタスクを効率化するコマンド：

### Claude Code カスタムスラッシュコマンド

このリポジトリには、Claude Codeで使用できるカスタムスラッシュコマンドが含まれています：

#### プロジェクト固有のコマンド（`.claude/commands/`）

- **`/project:sync-remote`** - 現在のブランチをリモートの最新状態に同期
  - リモートから最新の変更を取得（fetch）
  - 現在のブランチをリモートにリベース
  - コンフリクトがある場合は解決方法を提案

#### カスタムコマンドの作成方法

1. **プロジェクト固有のコマンド**: `.claude/commands/` ディレクトリにMarkdownファイルを作成
   - 例: `.claude/commands/deploy.md` → `/project:deploy` として利用可能

2. **ユーザー固有のコマンド**: `config/claude/commands/` ディレクトリにMarkdownファイルを作成
   - dotfilesリポジトリで管理され、install.shにより `~/.claude/commands/` にシンボリックリンクされる
   - 例: `config/claude/commands/review.md` → `/user:review` として利用可能
   - 汎用的なコマンド（GitHub CI、ブランチ管理など）はここに配置

### 従来のカスタムコマンド（CLAUDE.md用）

### `/setup` - 初期セットアップ
dotfilesのインストールを初期化または検証：
1. まだ実行されていない場合は`./install.sh`を実行
2. シンボリックリンクが適切に作成されているか確認
3. 必要なツールがすべてインストールされているか検証（Homebrew、pyenv、tfenvなど）
4. 不足している依存関係を報告
5. 手動設定の次のステップを提案（AWS認証情報など）

### `/update` - 設定を更新
特定の設定ファイルを更新：
- `/update zsh` - Zsh設定ファイルを更新
- `/update git` - Git設定を更新
- `/update aws` - AWS設定テンプレートを更新

### `/check` - ヘルスチェック
設定の整合性を検証：
1. 壊れたシンボリックリンクをチェック
2. 設定構文を検証
3. 追跡されたファイルに機密データがないことを確認

### `/optimize` - パフォーマンス最適化
シェル起動時間を分析して最適化：
1. Zsh起動時間をプロファイル
2. 読み込みが遅いモジュールを特定
3. 最適化を提案

### `/sync-remote` - リモートブランチとの同期 [廃止予定]
> **注意**: このコマンドはCLAUDE.mdドキュメント用です。
> 実際のカスタムスラッシュコマンドは `/project:sync-remote` として
> `.claude/commands/sync-remote.md` に実装されています。

## ワークフローガイドライン

### 1. 設定変更
設定ファイルを変更する際：
1. **計画**: 変更するファイルとその依存関係を特定
2. **テスト**: 可能であれば隔離された環境で変更を検証
3. **文書化**: このファイルの関連セクションを更新
4. **コミット**: Conventional Commitメッセージを使用

### 2. 新しいツールの統合
新しいツールのサポートを追加する際：
1. 適切なディレクトリにモジュラー設定ファイルを作成
2. シンボリックリンクが必要な場合はinstall.shを更新
3. 上記の主要ツールセクションにツールを追加
4. 特別なセットアップ要件を文書化

### 3. セキュリティに関する考慮事項
- 認証情報やAPIキーを決してコミットしない
- 機密設定には`.local`ファイルを使用
- 偶発的な秘密情報の露出がないか変更をレビュー
- 明確なプレースホルダーを持つテンプレートファイルを使用

## 継続的改善

### 振り返りの質問
重要な変更後に考慮すること：
- 変更はワークフローの効率を改善したか？
- 抽象化できるパターンはあるか？
- どのドキュメントを更新する必要があるか？
- さらに自動化できるか？

### パフォーマンスメトリクス
追跡と最適化：
- シェル起動時間（目標：<500ms）
- コマンド実行速度
- リポジトリナビゲーション効率
- 設定リロード時間

## 新しいユーティリティ機能

### PATH管理ツール
- `path_diagnostic()` - PATH設定の詳細診断（存在確認、セキュリティ評価）
- `find_duplicate_paths()` - 重複パスの検出と表示
- `clean_path()` - PATH環境変数のクリーンアップ

### エイリアス管理ツール
- `list_aliases()` - 設定済みエイリアスの一覧表示
- `show_category_aliases <category>` - カテゴリ別エイリアス表示
- `check_alias_conflicts()` - エイリアス競合の検出

### 遅延読み込み管理
- `list_loaded_functions()` - 読み込み済み関数の追跡
- `clear_function_cache()` - 関数キャッシュのクリア
- `show_function_errors()` - 関数読み込みエラーログの表示

### プロンプト管理
- `clear_prompt_cache()` - プロンプトキャッシュのクリア
- `reload_prompt()` - プロンプト設定の再読み込み
- `prompt_debug()` - プロンプト情報のデバッグ表示
- `set_timer_threshold <ms>` - コマンド実行時間表示のしきい値設定

# 重要な指示の再確認
要求されたことだけを行い、それ以上でもそれ以下でもない。
目標を達成するために絶対に必要でない限り、ファイルを作成しない。
常に新しいファイルを作成するよりも既存のファイルを編集することを優先する。
ユーザーから明示的に要求されない限り、ドキュメントファイル（*.md）やREADMEファイルを積極的に作成しない。