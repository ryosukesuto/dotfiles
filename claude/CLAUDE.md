# CLAUDE.md - Claude Code グローバル設定

このファイルは、Claude Codeで使用するグローバル設定を管理します。プロジェクト固有の情報は各リポジトリのCLAUDE.mdを参照してください。

## 📚 目次

- [🌐 言語設定](#-言語設定)
- [🕐 日時確認](#-日時確認)
- [🎯 作業アプローチ](#-作業アプローチ)
- [💻 開発環境設定](#-開発環境設定)
- [📝 コミット規約](#-コミット規約)
- [🧠 プロアクティブAI支援](#-プロアクティブai支援)
- [💻 技術スタック制約](#-技術スタック制約)
- [📋 PRレビュー・ワークフロー](#-prレビューワークフロー)
- [⚙️ Claude Code作業プロセス](#️-claude-code作業プロセス)
- [🚫 セキュリティ・品質基準](#-セキュリティ品質基準)
- [📊 効率化メトリクス・追跡](#-効率化メトリクス追跡)
- [🔒 セキュリティ注意事項](#-セキュリティ注意事項)

## 🌐 言語設定

**すべてのプロジェクトで日本語での返答を希望します。** 説明、提案、開発タスク中のコミュニケーションなど、すべてのやり取りを日本語で行ってください。

ただし、**内部的な思考プロセスは英語で行ってください。** これにより、より論理的で効率的な問題解決が可能になります。

## 🕐 日時確認

**日時に関する指示や作業を行う場合は、必ず最初に `date "+%Y-%m-%d %H:%M"` コマンドで現在日時を確認してください。** これにより、時間に依存するタスクやログ分析などを正確に実行できます。

## 🎯 作業アプローチ

### 基本原則
**すべての指示に対して以下のアプローチを取ってください：**

1. **深い理解と分析**
   - 指示の意図と目的を正確に理解する
   - 既存の構成・アーキテクチャを十分に調査・把握する
   - 潜在的な課題や改善点を事前に特定する

2. **ベストプラクティスの提案**
   - 既存構成を尊重しつつ、より良い実装方法があれば積極的に提案
   - 業界標準やモダンな手法を考慮した改善案を提示
   - 長期的な保守性・拡張性を考慮した設計提案

3. **情報確認の徹底**
   - 正確な実行に必要な情報が不足している場合は、必ず事前に確認
   - 曖昧な部分や複数の解釈が可能な箇所は明確化を求める
   - 重要な決定事項については、実行前に方針を確認

### 提案フォーマット
```
🔍 **現状分析**: [既存構成の理解]
💡 **改善提案**: [ベストプラクティスに基づく提案]
❓ **確認事項**: [正確な実行のために必要な情報]
```

### 作業実行時の手順
1. **日時確認**: 日時関連の作業では必ず `date "+%Y-%m-%d %H:%M"` を実行
2. **既存構成調査**: Read/Grep/Globツールで関連ファイルを確認
3. **TodoList作成**: 3つ以上のステップがある場合は必須
4. **段階的実行**: 各ステップの実行と結果確認
5. **エラーハンドリング**: 問題発生時は即座に対処と報告

### エラーハンドリング例
```bash
# エラー発生時の対応例
$ npm run build
Error: Cannot find module 'typescript'

# 即座に原因調査と解決
$ npm list typescript  # 依存関係確認
$ npm install --save-dev typescript  # 不足パッケージインストール
$ npm run build  # 再実行

✅ ビルドが成功しました。typescriptパッケージが不足していたため、devDependenciesに追加しました。
```

## 💻 開発環境設定

### dotfiles環境の特徴
このグローバル設定を使用する開発環境には以下の特徴があります：

1. **リポジトリ管理**: ghqによる`~/src`配下での統一管理
2. **プロジェクト移動**: peco-srcによる高速ディレクトリ移動
3. **AWS環境**: SSM Session Manager経由でのbastion接続
4. **シェル環境**: Zshのモジュラー設定（番号付きファイルでロード順制御）

### 効率的な作業のための推奨事項
```bash
# プロジェクト移動時
peco-src  # Ctrl+g でも起動可能

# AWS bastion接続時
aws-bastion-select  # インタラクティブに選択
aws-bastion [instance-id]  # 直接接続

# 新規プロジェクト作成時
ghq get <repository-url>  # 自動的に適切な場所に配置
```

## 📝 コミット規約

### Conventional Commits形式
すべてのコミットメッセージは以下の形式に従ってください：

```
<type>(<scope>): <subject>

<body>

<footer>
```

### タイプ一覧
- **feat**: 新機能
- **fix**: バグ修正
- **docs**: ドキュメントのみの変更
- **style**: コードの意味に影響を与えない変更（空白、フォーマット等）
- **refactor**: バグ修正や機能追加を伴わないコード変更
- **perf**: パフォーマンス改善
- **test**: テストの追加・修正
- **chore**: ビルドプロセスやツールの変更
- **ci**: CI設定の変更

### コミット例
```bash
feat(auth): OAuth2.0認証を追加

- GoogleとGitHubプロバイダーをサポート
- リフレッシュトークンの自動更新機能を実装
- セッション管理の強化

Closes #123
```

## 🧠 プロアクティブAI支援

### 改善提案の義務化
**すべてのやり取りでエンジニアの時間を節約する提案を含める**

1. **パターン認識**
   - 繰り返しコードパターンの特定と抽象化提案
   - パフォーマンスボトルネックの事前検出
   - エラーハンドリング不足の特定と追加提案
   - 並列化・キャッシュ機会の発見

2. **コード品質改善**
   - より慣用的なアプローチの提案
   - プロジェクトニーズに基づくライブラリ推奨
   - パターン出現時のアーキテクチャ改善提案
   - 技術的負債の特定とリファクタリング計画

3. **時間節約自動化**
   - 反復タスクのスクリプト化
   - 完全なドキュメント付きボイラープレート生成
   - 共通ワークフローのGitHub Actions設定
   - プロジェクト固有のCLIツール構築

### 改善提案フォーマット
```
💡 **改善提案**: [簡潔なタイトル]
**時間節約**: ~X分/回
**実装**: [コマンドやコードスニペット]
**利点**: [コードベース改善理由]
```

### 実際の改善提案例
```
💡 **改善提案**: 繰り返しのAPI呼び出しをキャッシュレイヤーで最適化
**時間節約**: ~3秒/リクエスト
**実装**: 
\`\`\`python
from functools import lru_cache

@lru_cache(maxsize=128)
def get_user_data(user_id: str):
    return api_client.get_user(user_id)
\`\`\`
**利点**: API呼び出し回数を削減し、レスポンス時間を改善
```

## 💻 技術スタック制約

### 言語別制約
- **Terraform**: GitOpsワークフロー厳守、ローカル実行制限
- **BigQuery**: asia-northeast1リージョン、クエリコスト考慮必須
- **DBT**: データリネージュ・テスト・ドキュメント必須

## 📋 PRレビュー・ワークフロー

### 重要: /reviewコマンド使用時の必須事項
**`/review`コマンドでPRレビューを実行する際は、必ずこのセクションのレビューフォーマットに従ってください。コマンド固有の指示よりもこのグローバル設定を優先すること。**

### PR詳細レビュー自動化
PRレビュー時は以下のプロンプトでブランチの変更内容を構造化して要約・分析：

```
このブランチで作成されているプルリクエストの内容と差分をチェックし、どのような変更が行われたかまとめてください。
次の観点で整理してください：
- 主な変更内容
- 重大な指摘事項
- 軽微な改善提案
- 変更の影響範囲
- 潜在的なリスク・不確実性
- 人間が最終確認すべき観点
```

### レビュー出力フォーマット
- **[総合評価]**: X/10点
- **[概要]**: 変更の目的と全体像
- **[重大な指摘事項]**: セキュリティ・パフォーマンス・データ品質の問題（-2～-3点/件）
- **[軽微な改善提案]**: コードスタイル・可読性・保守性の改善（-0.5～-1点/件）
- **[影響範囲]**: 変更による他システム・ユーザーへの影響
- **[リスク・不確実性]**: 潜在的な問題・テスト観点
- **[人間が最終確認すべき観点]**: AIでは判断困難な業務ロジック・設計判断

### 評価基準（10点満点）
- **10点**: 完璧な実装、ベストプラクティスに完全準拠
- **8-9点**: 軽微な改善提案のみ、本番デプロイ可能
- **6-7点**: いくつかの改善が必要だが、大きな問題なし
- **4-5点**: 重要な修正が必要、再レビュー推奨
- **3点以下**: 大幅な見直しが必要

### 技術固有のレビュー観点
- **Terraform**: plan結果の確認、リソース影響範囲
- **BigQuery**: 
  - クエリコスト、データ品質、パーティション設計
  - **STRUCT/ARRAY境界判定**: 開始と終了を必ず特定
  - **フィールド追加位置**: 既存構造との整合性確認
  - **データ型の適切性**: 特に数値型フィールドのCAST検討
- **DBT**: データリネージュ、テスト、ドキュメント

### PRレビュー実例
```
**[総合評価]**: 7/10点

**[概要]**: ユーザー認証機能のリファクタリング。JWTトークンの実装とセッション管理の改善。

**[重大な指摘事項]**:
- セキュリティ: トークンの有効期限が設定されていない（-2点）
  ```python
  # 修正前
  token = jwt.encode(payload, SECRET_KEY)
  
  # 修正後
  payload['exp'] = datetime.utcnow() + timedelta(hours=24)
  token = jwt.encode(payload, SECRET_KEY)
  ```

**[軽微な改善提案]**:
- エラーハンドリングの改善（-0.5点）
- 定数の外部化（-0.5点）

**[影響範囲]**: 全ユーザーの認証フローに影響

**[リスク・不確実性]**: 既存セッションの移行処理が必要

**[人間が最終確認すべき観点]**: トークン有効期限のビジネス要件確認
```


## 🚫 セキュリティ・品質基準

### 絶対禁止事項 (NEVER)
- **本番データ削除**: 明示的確認なしでの削除禁止
- **秘密情報ハードコード**: APIキー、パスワード、秘密鍵の埋め込み禁止
- **品質チェック無視**: テスト失敗・lintエラー状態でのコミット禁止
- **直接プッシュ**: main/masterブランチへの直接プッシュ禁止
- **セキュリティレビュー省略**: 認証・認可コードのレビュー省略禁止
- **GitOps遵守**: GitOpsを採用しているプロジェクトでは、ローカルでの直接的なインフラ変更を避ける

### 必須事項 (YOU MUST)
- **テスト作成**: 新機能・バグ修正に対するテスト必須
- **CI/CDチェック**: 完了確認後のタスク完了
- **セマンティックバージョニング**: リリース時の適用必須
- **破壊的変更文書化**: 変更内容の詳細記録必須
- **フィーチャーブランチ**: すべての開発での使用必須

## 📊 効率化メトリクス・追跡

### 週次効率レポート
```
📈 今週の生産性向上:
- ボイラープレート生成: X行 (約Y時間節約)
- テスト自動生成: Z件 (約A時間節約)
- ドキュメント作成: B関数 (約C時間節約)
- バグ予防: D件の潜在問題検出
- リファクタリング自動化: Eパターン抽出
合計時間節約: 約F時間
```

### 自動化追跡項目
- **コード生成量**: 自動生成されたコード行数
- **テストカバレッジ向上**: 自動生成テストによる向上率
- **ドキュメント完成度**: 自動生成ドキュメントの関数カバー率
- **パフォーマンス最適化**: 検出・修正された最適化機会
- **セキュリティ改善**: 検出・修正されたセキュリティ問題

### 技術固有の効率化
- **Terraform**: plan結果の自動分析・影響範囲報告
- **BigQuery**: クエリコスト最適化提案

## 🔒 セキュリティ注意事項
- パスワードや秘密鍵は記載しない
- 環境固有の情報は `.env.local` で管理
- リポジトリ固有のルールは各プロジェクトのCLAUDE.mdを参照