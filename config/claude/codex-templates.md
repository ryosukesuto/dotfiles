# Codex レビュー依頼テンプレート集

このファイルは、Codexに依頼する際の詳細なテンプレートと使用例を提供します。

> **参照元**: GLOBAL_SETTINGS.md の「Codexとの協業」セクション

---

## 📋 目次

1. [依頼標準テンプレート](#依頼標準テンプレート)
2. [Codexへの指示と制約](#codexへの指示と制約)
3. [期待する出力フォーマット](#期待する出力フォーマット)
4. [PRレビューのベストプラクティス](#prレビューのベストプラクティス)
5. [フェーズ1: 実装前レビュー](#フェーズ1-実装前レビュー)
6. [フェーズ2: コミット前レビュー](#フェーズ2-コミット前レビュー)
7. [フェーズ3: PR作成前レビュー](#フェーズ3-pr作成前レビュー)

---

## 依頼標準テンプレート

Codexに依頼する際は、以下の構造を使用して明確な指示を提供します：

```markdown
# 依頼の目的
[何を達成したいのか、なぜこのレビュー/分析が必要なのかを1-2文で]

## 制約条件
- リポジトリへのアクセス: read-only
- 変更を加えない: コードの分析・評価のみ
- [その他の制約があれば追加]

## 入力情報
[提供する情報：PR番号、ファイルパス、差分、実装概要など]

## レビュー/分析観点
1. 🚨 セキュリティ: [具体的な観点]
2. ⚠️ パフォーマンス: [具体的な観点]
3. 💡 保守性: [具体的な観点]
4. 📝 可読性/ドキュメント: [具体的な観点]

## 期待する出力
- 形式: [マークダウン、リスト形式、表など]
- 優先度マーカー: 🚨 Critical, ⚠️ Warning, 💡 Suggestion, ✅ Good
- 具体的な改善案: コード例を含める
- 次のアクションアイテム: 実装すべきタスクのリスト

## 補足情報
[コンテキスト、背景、既知の問題など]
```

### 実用例: Terraform PRレビュー

```bash
cat > /tmp/codex_request.txt <<'EOF'
# 依頼の目的
PR #123のTerraform設定変更をセキュリティとベストプラクティスの観点でレビューしてください。

## 制約条件
- リポジトリへのアクセス: read-only
- 実装の変更は行わない（分析・提案のみ）
- AWS環境への影響を重視

## 入力情報
- PR URL: https://github.com/org/repo/pull/123
- 主要変更: IAMポリシー追加、S3バケット設定変更
- 変更行数: 約300行

## レビュー/分析観点
1. 🚨 セキュリティ: 過度な権限付与、公開バケット設定、認証情報の露出
2. ⚠️ パフォーマンス: リソース設定の妥当性
3. 💡 保守性: 変数化の適切性、命名規則の一貫性
4. 📝 ドキュメント: README更新、variables.tfのdescription

## 期待する出力
- 優先度別の問題リスト（🚨⚠️💡✅）
- 各問題に対する具体的な改善案（Terraformコード例）
- 次のアクションアイテム（優先順位付き）

## 補足情報
このPRはSandbox環境へのデプロイ前の最終レビューです。
本番環境への影響はありませんが、ベストプラクティスの確認が重要です。
EOF

codex exec "$(cat /tmp/codex_request.txt)"
```

---

## Codexへの指示と制約

Codexに対して明示的に伝えるべき振る舞いと制約：

### ✅ Codexがやるべきこと

- コードの分析・評価（セキュリティ、パフォーマンス、保守性）
- ベストプラクティスとの比較
- 潜在的な問題の特定と具体的な改善案の提示
- 代替実装の提案と比較評価
- ドキュメント不足の指摘
- 依存関係の分析と影響範囲の評価

### ❌ Codexがやってはいけないこと

- コードの直接的な変更や修正（read-onlyアクセス）
- 実装の代行（Claude Codeの役割）
- 曖昧な指摘（「改善の余地がある」など具体性のない表現）
- 優先度のない問題の羅列（必ず🚨⚠️💡✅で分類）
- コンテキストを無視した画一的な指摘

### 判断基準

- 🚨 **Critical**: セキュリティ脆弱性、データ損失リスク、本番障害の可能性
- ⚠️ **Warning**: パフォーマンス問題、保守性の低下、将来的な技術的負債
- 💡 **Suggestion**: より良い実装方法、可読性向上、ベストプラクティス適用
- ✅ **Good**: 適切に実装されている点、評価すべき設計判断

---

## 期待する出力フォーマット

Codexからの出力は以下の構造を期待します：

```markdown
# レビュー/分析結果

## 📊 概要
- 総評: [全体的な評価を2-3文で]
- 主要な問題: X件（🚨 N件、⚠️ N件、💡 N件）
- 良い点: [評価できる実装をリストアップ]

## 🚨 Critical Issues
### 1. [問題のタイトル]
- **場所**: `ファイル名:行番号`
- **問題**: [何が問題か]
- **影響**: [どんな影響があるか]
- **改善案**:
  ```language
  # 具体的なコード例
  ```
- **理由**: [なぜこの改善が必要か]

## ⚠️ Warnings
[同様の構造]

## 💡 Suggestions
[同様の構造]

## ✅ Good Practices
- [評価できる実装とその理由]

## 📋 次のアクションアイテム
1. [ ] [優先度高] タスク内容（期待所要時間）
2. [ ] [優先度中] タスク内容（期待所要時間）
3. [ ] [優先度低] タスク内容（期待所要時間）

## 🔍 補足情報
[追加で調査すべき点、参考資料、関連する技術ドキュメントなど]
```

---

## PRレビューのベストプラクティス

### 基本アプローチ: CodexにPR番号を伝えるだけ

Codexは`gh`コマンドや`git`コマンドを使えるため、差分を事前に取得して渡す必要はありません。
PR番号と背景・目的を伝えれば、Codexが自分で必要な情報を取得してレビューします。

### 標準的なPRレビュー依頼

```bash
cat > /tmp/pr_review.txt <<'EOF'
# 依頼の目的
PR #123のレビューをお願いします。

## 背景・目的
[なぜこの変更が必要か、何を達成したいか]

## レビュー観点
1. 🚨 セキュリティ: [具体的な懸念点]
2. ⚠️ パフォーマンス: [チェックしてほしい点]
3. 💡 保守性: [コード品質、設計]
4. 📝 ドキュメント: [ドキュメント更新の妥当性]

## 期待する出力
- 優先度別の問題リスト（🚨⚠️💡✅）
- 各問題に対する具体的な改善案
- 次のアクションアイテム

**gh pr viewとgh pr diffコマンドで差分を確認してレビューしてください。**
EOF

codex exec "$(cat /tmp/pr_review.txt)"
```

### Terraform PRレビュー例

```bash
cat > /tmp/terraform_pr_review.txt <<'EOF'
# 依頼の目的
PR #456のTerraform変更をレビューしてください。

## 背景・目的
S3バケットとIAMポリシーを追加してデータバックアップ機能を実装します。

## レビュー観点
1. 🚨 セキュリティ: 過度な権限付与、公開アクセス設定、暗号化
2. ⚠️ コスト: ストレージクラス、ライフサイクルポリシー
3. 💡 保守性: 命名規則、変数化、タグ付け
4. 📝 ドキュメント: README更新、variables.tfのdescription

## 期待する出力
- セキュリティ上の懸念点
- ベストプラクティスからの逸脱
- 本番デプロイ前に確認すべき事項

**gh pr diffで差分を確認し、必要に応じて関連ファイルも読んでください。**
EOF

codex exec "$(cat /tmp/terraform_pr_review.txt)"
```

### タイムアウト設定による使い分け

1. **小〜中規模PR（〜1000行）**: デフォルトタイムアウト（2分）で十分
2. **大規模PR（1000〜2000行）**: タイムアウトを5-10分に延長
3. **超大規模PR（2000行以上）**:
   - 実装概要と主要ファイル一覧を提供
   - Codexが重点的にレビューすべきファイルを指示
   - タイムアウトを10分に設定

### 大規模PRの依頼例

```bash
cat > /tmp/large_pr_review.txt <<'EOF'
# 依頼の目的
PR #789の大規模変更（2000行以上）をレビューしてください。

## 背景・目的
認証システムのリファクタリングとセキュリティ強化

## 実装概要
- JWT認証の実装
- セッション管理の改善
- パスワードハッシュ化方式の変更

## 重点レビュー対象ファイル
1. auth/jwt.py - JWT生成・検証ロジック
2. auth/password.py - パスワードハッシュ化
3. middleware/auth.py - 認証ミドルウェア

## レビュー観点
1. 🚨 セキュリティ: トークン漏洩、タイミング攻撃、リプレイ攻撃
2. ⚠️ パフォーマンス: 認証処理のボトルネック
3. 💡 保守性: エラーハンドリング、テストカバレッジ

**gh pr diffで差分を確認し、上記ファイルを重点的にレビューしてください。**
**関連する既存ファイルも必要に応じて読んで、整合性を確認してください。**
EOF

codex exec "$(cat /tmp/large_pr_review.txt)"
# タイムアウトを10分に設定（Claude CodeのBashツールで timeout: 600000 を指定）
```

### レビュー依頼の構造（推奨）

```
1. 依頼の目的（何をレビューしてほしいか）
2. 背景・目的（なぜこの変更が必要か）
3. レビュー観点（優先度付き）
4. 期待する出力（フォーマット、詳細度）
5. 指示（gh/gitコマンドで差分確認を明示）
```

### メリット

- 依頼がシンプルで明確
- Codexが必要な情報を柔軟に取得できる
- 関連ファイルも含めた包括的なレビューが可能
- 差分サイズを気にせず依頼できる

---

## フェーズ1: 実装前レビュー

実装を始める前に、計画やTODOリストをCodexで確認します。

### テンプレート

```bash
cat > /tmp/pre_review.txt <<'EOF'
# 依頼の目的
以下の実装計画をレビューしてください。

## 背景・目的
[何を達成したいか]

## 実装計画・TODO
- [ ] タスク1
- [ ] タスク2
- [ ] タスク3

## 技術スタック・アプローチ
[使用する技術、設計方針]

## 懸念点
[セキュリティ、パフォーマンス、保守性の不安要素]

## レビュー観点
1. 🚨 セキュリティ: 設計上のリスク
2. ⚠️ パフォーマンス: ボトルネックの可能性
3. 💡 保守性: より良い設計パターン
4. 📝 実装漏れ: 考慮すべきエッジケース

## 期待する出力
- 計画の妥当性評価
- リスク・潜在的な問題点
- 推奨する改善案・代替アプローチ
EOF

codex exec "$(cat /tmp/pre_review.txt)"
```

### 実施タイミング

- セキュリティ・インフラに影響する変更
- アーキテクチャ変更
- 初めて扱う技術スタック
- 複雑な実装（3時間以上かかる見込み）

---

## フェーズ2: コミット前レビュー

実装完了後、コミット前にローカル変更をCodexで確認します。

### テンプレート

```bash
cat > /tmp/commit_review.txt <<'EOF'
# 依頼の目的
コミット前の変更をレビューしてください。

## 背景・目的
[何を実装したか、なぜ必要か]

## 実施済みの確認
- [x] lint/typecheck通過
- [x] テスト実行（全てグリーン）
- [x] 動作確認完了

## レビュー観点
1. 🚨 セキュリティ: [懸念点があれば]
2. ⚠️ パフォーマンス: [チェックしてほしい点]
3. 💡 保守性: コード品質、可読性
4. 📝 ドキュメント: 更新の妥当性

## 期待する出力
- 見落としている問題
- 改善できる点
- コミット前に対応すべき事項

**git statusとgit diffで変更内容を確認してレビューしてください。**
EOF

codex exec "$(cat /tmp/commit_review.txt)"
```

### 実施タイミング

- 実装完了後、コミット前（必須ではない）
- セキュリティ関連変更後（必須）
- Terraform変更後（必須）
- 複雑な変更・リファクタリング後

---

## フェーズ3: PR作成前レビュー

PR作成後、マージ前に最終確認としてCodexでレビューします。

### テンプレート

```bash
cat > /tmp/pr_review.txt <<'EOF'
# 依頼の目的
PR #123の最終レビューをお願いします。

## 背景・目的
[なぜこの変更が必要か]

## レビュー観点
1. 🚨 セキュリティ: [具体的な観点]
2. ⚠️ パフォーマンス: [具体的な観点]
3. 💡 保守性: コード品質、設計
4. 📝 ドキュメント: 更新の妥当性

## 期待する出力
- マージ前に対応すべき問題
- 改善提案
- 次のPRで対応すべき技術的負債

**gh pr viewとgh pr diffで差分を確認してレビューしてください。**
EOF

codex exec "$(cat /tmp/pr_review.txt)"
```

### 実施タイミング

- PR作成後、マージ前
- CI/CDが全てグリーンになった後

---

## 📋 各フェーズの使い分け

| フェーズ | タイミング | 必須度 | 対象 |
|---------|-----------|--------|------|
| **実装前** | 実装開始前 | △ | 計画・TODO・設計 |
| **コミット前** | テスト通過後 | △ | git diff（ローカル変更） |
| **PR作成前** | PR作成後 | ○ | gh pr diff（PR差分） |

### 省略可能なケース

- ドキュメントのみの更新
- タイポ修正
- 設定値の変更のみ（ロジック変更なし）

### 必須とするケース

- セキュリティ関連（認証、IAM、暗号化）
- インフラ変更（Terraform、DBスキーマ）
- 本番影響が大きい変更
