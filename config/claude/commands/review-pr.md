# PRレビューコマンド（拡張版）

このPRを包括的にレビューして、建設的かつ実用的なフィードバックを提供してください。

## コードレビューの3つの目的

1. **🐛 短期的品質（バグの早期発見）**
   - ダブルチェックによるバグ・仕様漏れの発見
   - 発覚が遅くなるほどコストが増大（本番障害 > QA発見 > レビュー発見）
   - 例：「仕様に反しています」「このケースでエラーが起きませんか？」

2. **🏗️ 中長期的品質（内部品質の担保）**
   - 将来を見据えた設計・実装の確保
   - 保守性・拡張性・パフォーマンスの維持
   - 例：「N+1が発生します」「責務が混在しています」「命名が分かりにくい」

3. **📢 周知（チーム内の情報共有）**
   - 共通部分への変更の周知
   - 並行開発時の影響確認
   - 例：「共通コンポーネントを変更したので確認してください」

## レビュー依頼者の責任

### 必須：PR説明の充実化
1. **背景説明**
   - 何を解決しようとしているか明確に記載
   - Issue/チケット/設計ドキュメントへのリンク
   - 1年後の新メンバーが経緯を追えるか？

2. **レビュー観点の明示**
   - ✅ 周知だけで良いのか？
   - 🔍 不安な部分のダブルチェックが必要か？
   - 💭 命名やアーキテクチャの意見が欲しいか？
   - 特に確認してほしい箇所を明記

3. **先回りコメント（レビュワーの負担軽減）**
   - 「なぜこの実装にしたか」の理由と経緯（リンク付き）
   - 使用ライブラリ・メソッドへの1次情報リンク（バージョン付き）
   - 既存コードとの関連性（参考にしたファイルへのリンク）
   - 複雑なロジックの説明

4. **視覚的補助**
   - **Frontend**: UIコンポーネントごとのスクリーンショット
   - **Backend**: RSpec実行結果（`-f d`オプション付き）の貼り付け
   ```bash
   # RSpec実行結果の例
   bundle exec rspec spec/models/user_spec.rb -f d
   ```

## レビュー手順

### 1. **PR経緯の把握（必須）**
   ```bash
   # PRタイトル・説明・コメント履歴から背景と意図を理解
   gh pr view --json number,title,body,author,state,comments,reviews

   # PR作成者の意図・背景・解決したい課題を確認
   # 既存のコメント（議論・質問・回答）も含めて把握
   gh pr view --comments

   # 既存のレビューコメントを確認
   gh pr view --json reviews --jq '.reviews[] | {author: .author.login, state: .state, body: .body}'
   ```

   **重要**: 必ず以下を把握してからレビューを開始
   - PRの目的・解決しようとしている問題
   - なぜこの実装方法を選択したか
   - 既に議論されたコメント内容（質問・回答・懸念事項）
   - 議論された代替案や制約事項
   - PR作成者が特に確認してほしい点
   - 既存のレビュー指摘と対応状況

### 2. **自動情報収集**
   ```bash
   # PR基本情報の取得
   gh pr view --json number,title,body,author,state,files,additions,deletions,commits

   # 変更内容の詳細確認
   gh pr diff

   # CI/CDステータス確認
   gh pr checks

   # 既存のレビューコメント確認
   gh api repos/{owner}/{repo}/pulls/{pr}/reviews --jq '.[].state' | sort | uniq -c

   # ファイル変更統計
   git diff --stat origin/main...HEAD
   ```

### 3. **AI補助分析（内部処理）**
   ```bash
   # PRの差分を取得
   PR_DIFF=$(gh pr diff)

   # AI分析ツールで包括的なコードレビューを実施（バックグラウンド処理）
   # 注意: この分析結果は参考情報として扱い、最終判断は人間のレビュワーが統合して提示する
   AI_PROMPT="このPRの変更内容をレビューし、JSON形式で評価してください。

評価基準:
1. 🔒 セキュリティ（security_score: 0-100）
   - 認証・認可の不備
   - 入力検証の欠如
   - 機密情報の露出リスク（パスワード、APIキー、トークン）
   - OWASP Top 10に該当する問題
   - SQLインジェクション、XSS、CSRFなどの脆弱性

2. ⚡ パフォーマンス（performance_score: 0-100）
   - N+1クエリ問題
   - 非効率なアルゴリズム（O(n^2)以上の計算量）
   - リソース使用量の課題（メモリリーク、CPU使用率）
   - スケーラビリティへの影響
   - 不要な再レンダリング（Frontend）

3. ✨ コード品質（quality_score: 0-100）
   - 可読性（複雑すぎる関数、深いネスト）
   - 保守性（重複コード、マジックナンバー）
   - テスタビリティ（テストしにくい設計）
   - DRY原則違反
   - 命名規則の一貫性

4. 🏗️ アーキテクチャ（architecture_score: 0-100）
   - 責務分離の不足
   - 設計パターンの不適切な使用
   - 拡張性の問題
   - SOLID原則違反
   - 依存関係の適切性

出力JSON形式:
{
  \"status\": \"ok\" | \"warning\" | \"critical\",
  \"security_score\": 0-100,
  \"performance_score\": 0-100,
  \"quality_score\": 0-100,
  \"architecture_score\": 0-100,
  \"overall_score\": 0-100,
  \"critical_issues\": [
    {\"file\": \"path/to/file:line\", \"type\": \"security\", \"issue\": \"具体的な問題\", \"suggestion\": \"改善案\"}
  ],
  \"high_issues\": [...],
  \"medium_issues\": [...],
  \"low_issues\": [...],
  \"positive_points\": [\"良かった点1\", \"良かった点2\"],
  \"summary\": \"全体的な評価の要約（1-2文）\"
}

---PRの変更内容---
$PR_DIFF
"

   # AI分析実行（タイムアウト30秒、JSON出力）
   codex exec --json --color never "$AI_PROMPT" 2>/dev/null | \
     jq -c 'select(.msg.type == "agent_message")' | \
     tail -n 1 | \
     jq -r '.msg.message' > /tmp/ai-pr-review.json

   # JSON妥当性チェック
   if jq empty /tmp/ai-pr-review.json 2>/dev/null; then
     echo "✅ AI分析完了: /tmp/ai-pr-review.json"
     # この結果を参考に、レビュワーが統合的なレビューを作成
   else
     echo "⚠️ AI分析失敗: JSON形式が不正です（レビュワーの判断のみでレビュー実施）"
   fi
   ```

   **重要**: AI分析結果は内部的に参照し、レビュワーが検証・統合した上で、一つのレビューとして提示してください。
   - AI指摘と人間の判断を分けて表示せず、統合的なレビューとして出力
   - False Positive（誤検知）は除外し、妥当な指摘のみを採用
   - プロジェクト固有の文脈や制約を考慮した判断を優先
   - 最終的なレビュー内容はレビュワーの責任で決定

### 4. **自動セキュリティチェック**
   ```bash
   # 秘密情報の検出（可能な場合）
   git diff origin/main...HEAD | grep -E "(password|secret|token|api[_-]?key)" -i

   # ハードコードされた認証情報のチェック
   git diff origin/main...HEAD | grep -E "(['\"])([A-Za-z0-9+/]{40,}|sk_live_[A-Za-z0-9]+|ghp_[A-Za-z0-9]+)(['\"])"
   ```

### 5. **評価観点（AI分析結果と人間の判断を統合）**

AI補助分析の結果（`/tmp/ai-pr-review.json`）を参照しつつ、以下の観点でレビューを実施：

#### 🐛 短期的品質（バグの早期発見）

##### 🔒 セキュリティ
**確認内容**:
- [ ] 認証・認可ロジックの実装が適切か（権限チェック漏れ、昇格脆弱性）
- [ ] 入力検証が全てのエンドポイント/フォームで実装されているか
- [ ] 機密情報（パスワード、APIキー、トークン）がハードコードされていないか
- [ ] SQLインジェクション、XSS、CSRFなどの脆弱性が存在しないか
- [ ] ファイルアップロード機能で拡張子・MIMEタイプの検証が適切か

**AI活用**: `critical_issues`（type: security）を優先確認、False Positiveは除外

**期待成果**: セキュリティ脆弱性が0件、または修正計画が明確

##### 🎯 仕様準拠
**確認内容**:
- [ ] PRの目的と実装内容が一致しているか
- [ ] エッジケース（空配列、null、エラー時）の処理が実装されているか
- [ ] エラーハンドリングが適切か（ユーザーへのメッセージ、ログ出力）
- [ ] 既存機能への影響がないか（回帰テストの必要性）

**AI活用**: プロジェクト固有の要件はAIが理解できないため、人間が重点的に確認

**期待成果**: 仕様との差異が0件、またはPR作成者との合意済み

##### ⚠️ バグリスク
**確認内容**:
- [ ] ロジックエラー（条件分岐の誤り、ループの境界値）がないか
- [ ] 型の不一致やnull参照の可能性がないか
- [ ] 並行処理における競合状態（race condition）がないか
- [ ] メモリリークやリソースリークの可能性がないか

**期待成果**: 明らかなバグが0件、または修正済み

#### 🏗️ 中長期的品質（内部品質の担保）

##### ⚡ パフォーマンス
**確認内容**:
- [ ] N+1クエリ問題が存在しないか（eager loading、バッチ処理の必要性）
- [ ] 非効率なアルゴリズム（O(n^2)以上）が使用されていないか
- [ ] 不要な再レンダリング（React useEffect、useMemo の活用）がないか
- [ ] データベースインデックスが適切に設定されているか
- [ ] キャッシュ戦略が適切か（TTL、invalidation）

**AI活用**: `high_issues`（type: performance）を参考、プロジェクトの規模・トラフィックを考慮

**期待成果**: 重大なパフォーマンス問題が0件、または改善計画が明確

##### 🏗️ アーキテクチャ
**確認内容**:
- [ ] 責務分離が適切か（Single Responsibility Principle）
- [ ] 依存関係が適切か（Dependency Inversion Principle）
- [ ] レイヤー構造が守られているか（Controller → Service → Repository）
- [ ] 設計パターンが適切に使用されているか（過剰な抽象化はないか）
- [ ] 将来の拡張性が考慮されているか

**AI活用**: `architecture_score`と`high_issues`を参考、プロジェクトの設計方針との整合性は人間が判断

**期待成果**: 設計上の問題が0件、または技術的負債として記録済み

##### ✨ コード品質
**確認内容**:
- [ ] 関数が適切な長さか（50行以内を目安、責務ごとに分割）
- [ ] ネストが深すぎないか（3階層以内、早期リターンの活用）
- [ ] 変数・関数名が意図を明確に表現しているか
- [ ] 重複コードがないか（3回以上の繰り返しは共通化）
- [ ] マジックナンバー・文字列が定数化されているか
- [ ] 不必要なコメントがないか（コードで自明、古いTODO）
- [ ] テストが適切に実装されているか（カバレッジ、境界値テスト）

**AI活用**: `quality_score`と`medium_issues`を参考、チームのコーディング規約との整合性を確認

**期待成果**: コード品質の問題が最小限、保守性が担保されている

##### 🔄 運用性
**確認内容**:
- [ ] ログ出力が適切か（INFO/WARN/ERROR の使い分け、機密情報の非出力）
- [ ] メトリクスが取得可能か（レスポンスタイム、エラー率）
- [ ] ロールバックが容易か（データベースマイグレーション、Feature Flag）
- [ ] 監視・アラートが設定可能か

**期待成果**: 運用上の問題が想定され、対策が明確

#### 📢 周知（チーム内の情報共有）

**確認内容**:
- [ ] 共通コンポーネント・ユーティリティの変更があるか
- [ ] APIの変更（Breaking Changes）があるか
- [ ] 外部サービス・ライブラリへの新規依存があるか
- [ ] 並行開発中の他機能への影響があるか

**期待成果**: 影響範囲が明確に文書化され、関係者に通知済み

---

**AI分析結果の活用方針**:
- AI スコアは参考値として扱い、絶対的な品質指標としない
- AI 検出の問題は必ず人間が妥当性を検証（False Positive 除外）
- プロジェクト固有の文脈・制約を考慮した判断を優先
- AI 検出の良い点（`positive_points`）も積極的に評価に反映

**各観点の判断基準**:
- **必須（🔴）**: セキュリティ、バグ、データ損失リスク → マージ不可
- **推奨（🟡）**: パフォーマンス、設計、保守性 → できれば対応
- **任意（🟢）**: 可読性、命名、スタイル → 余裕があれば対応

## フィードバック分類

各指摘には以下の分類を使用：

- 🔴 **critical.must**: 致命的な問題（セキュリティ脆弱性、データ損失リスク）
- 🟡 **high.imo**: 重要な改善（パフォーマンス問題、設計上の課題）
- 🟢 **medium.imo**: 中程度の改善（保守性、可読性の向上）
- 🟢 **low.nits**: 軽微な提案（スタイル、命名規則）
- 🔵 **info.q**: 質問・情報確認（実装意図、要件確認）

## 出力フォーマット

レビュー結果は、PR作成者が**実行可能なアクション**を取れるように、以下の形式で提示してください：

```markdown
## 総合評価: X/10点

**変更内容**: X files (+XXX/-XXX lines) | CI: ✅ Pass / ❌ Fail

## 概要
PRの目的と変更内容を1-2文で要約

## 修正が必要な点

### 🔴 必須（マージ前に対応必須）
修正なしではマージ不可の問題（セキュリティ、バグ、データ損失リスク）

**[file:line]**
- **問題**: 何が問題か
- **理由**: なぜ問題か（影響範囲）
- **修正方法**: 具体的な修正案（コード例を含む）

### 🟡 推奨（できれば対応してほしい）
重要な改善提案（パフォーマンス、設計、保守性）

**[file:line]**
- **提案**: 改善案
- **理由**: なぜ改善すべきか
- **方法**: どう改善するか（具体例）

### 🟢 検討（余裕があれば）
軽微な改善（可読性、命名、スタイル）
- **[file:line]** 簡潔な提案

## 質問・確認したい点
実装意図や要件の確認
- 質問事項（はい/いいえで答えられる形式が望ましい）

## 良かった点
具体的に称賛すべき実装とその理由
- 他の開発者の参考になる良い実装

## 注意事項
- **Breaking Changes**: なし / あり（詳細）
- **ロールバック**: 容易 / 注意が必要 / 困難（理由）
- **モニタリング**: 不要 / 推奨（監視項目）

## アクションアイテム（優先順位順）
1. 【必須】具体的な修正内容と期限の目安
2. 【推奨】改善提案の優先順位
3. 【任意】将来的な改善提案

## レビューステータス
- [ ] 変更要求（🔴必須項目の修正後に再レビュー）
- [ ] 承認保留（質問への回答待ち）
- [ ] 承認（LGTM - マージ可能）
```

**出力の原則**:
- PR作成者が次に何をすべきか明確にする
- 各指摘には必ず「理由」と「具体的な修正方法」を含める
- 優先順位を明確にし、何から着手すべきか分かるようにする
- 建設的で前向きなトーンを維持する
- 技術的に正確で、実装可能な提案をする

## 評価基準

- **10点**: 完璧、ベストプラクティス完全準拠
- **8-9点**: 軽微な改善のみ、デプロイ可能
- **6-7点**: いくつかの改善必要、大きな問題なし
- **4-5点**: 重要な修正必要、再レビュー推奨
- **3点以下**: 大幅な見直し必要

## レビュー原則

### 🎯 最優先事項：PR作成者への効果的なフィードバック

レビューの目的は、PR作成者が**次のアクションを明確に理解し、実行できるようにする**ことです。

### ✅ 効果的なレビューの特徴
1. **実行可能性**: PR作成者が具体的に何をすべきか明確
   - ❌ 「この実装は良くない」
   - ✅ 「この実装だとXXの問題が起きる。代わりにYYの方法を推奨（コード例付き）」

2. **優先順位の明確化**: 何から着手すべきか迷わない
   - 必須/推奨/任意の分類を徹底
   - アクションアイテムを優先順位順に列挙

3. **理由の説明**: なぜその修正が必要か理解できる
   - 技術的な根拠を示す
   - 影響範囲を明示する
   - 学習機会として活用できる説明

4. **建設的なトーン**: 前向きに改善に取り組める
   - 問題点だけでなく、良い点も積極的に評価
   - 批判ではなく、改善提案として伝える
   - PR作成者の努力や工夫を認める

5. **文脈の理解**: プロジェクトの状況を考慮
   - PR作成者の意図と背景を理解
   - 制約条件や経緯を考慮
   - 既に議論された内容は蒸し返さない

### ❌ 避けるべきレビュー
- **曖昧な指摘**: 「もっと良くできる」→ 何をどう改善するか不明
- **理由なし**: 「これは良くない」→ なぜ良くないか不明
- **優先度不明**: 全ての指摘が同じ重要度に見える
- **実装不可能**: 理想論だが、現実的には実装困難な提案
- **個人的好み**: チームの合意がない、主観的なスタイル指摘
- **過度な指摘**: 労力に対してメリットが小さい細かい改善の羅列

### 🔄 レビューワークフロー
1. **文脈把握** → PR作成者の意図を理解（PRタイトル・説明・コメント）
2. **AI補助分析参照** → 自動分析結果を確認（セキュリティ・パフォーマンス・品質）
3. **人間の判断** → AI結果を検証し、プロジェクト文脈を考慮
4. **統合レビュー作成** → 実行可能なフィードバックとして統合
5. **優先順位付け** → 必須/推奨/任意に分類
6. **具体的提案** → 修正方法とコード例を提示
7. **前向きなコメント** → 良い点も必ず評価

## 技術スタック別の観点

### フロントエンド
- パフォーマンス最適化（バンドルサイズ、レンダリング効率）
- アクセシビリティ（WCAG準拠、キーボード操作）
- レスポンシブデザイン、クロスブラウザ対応
- 状態管理の適切性

### バックエンド  
- API設計（RESTful/GraphQL原則）
- エラーハンドリング、リトライ戦略
- データベース設計、クエリ最適化
- 並行性制御、トランザクション管理

### インフラ・DevOps
- リソース効率性、コスト最適化
- 監視・ロギング戦略
- 障害復旧計画、冗長性
- セキュリティ設定（IAM、ネットワーク）

## 効率的なレビューのコツ

### レビュー前の準備
1. **PR作成者の意図を理解**: PRタイトル・説明・コメントから背景を把握
2. **AI補助分析を実行**: `codex exec`でPR差分を自動分析（30秒以内）
3. **レビュー観点の明確化**: 何を重点的に見るべきか（周知/ダブルチェック/設計レビュー）

### レビュー実施の流れ
1. **AI分析結果を確認**: `/tmp/ai-pr-review.json`の内容を確認
   - Critical/High issues を優先的に検証
   - スコアは参考値として扱う
   - False Positive（誤検知）を除外
2. **人間の判断で補完**: AI が見逃しやすい観点を重点確認
   - プロジェクト固有の要件・制約
   - ビジネスロジックの妥当性
   - チームのコーディング規約との整合性
3. **統合レビューを作成**: AI指摘と人間の判断を統合
   - PR作成者にとって実行可能なフィードバックに整理
   - 優先順位を明確化（必須/推奨/任意）
   - 具体的な修正方法とコード例を提示
4. **前向きな評価**: 良い点も必ず言及
   - AI の `positive_points` も参考にする
   - 学習機会として共有できる実装を称賛

### 効率化のポイント
- **AI 活用**: 機械的にチェック可能な項目（セキュリティ、パフォーマンス）はAIに任せる
- **本質に集中**: 人間は設計・要件・ビジネスロジックの妥当性に注力
- **差分に集中**: 変更された部分のみをレビュー対象とする
- **段階的レビュー**: 必須項目 → 推奨項目 → 任意項目の順で確認
- **建設的フィードバック**: 問題点だけでなく、改善案も必ず提示

### レビュー品質の担保
- **実行可能性**: PR作成者が次に何をすべきか明確か？
- **理由の説明**: なぜその修正が必要か説明できているか？
- **優先順位**: 必須/推奨/任意の分類が適切か？
- **建設的トーン**: 前向きに改善に取り組めるコメントか？

レビューを開始してください。AI補助分析を活用しつつ、PR作成者に効果的なフィードバックを提供してください。