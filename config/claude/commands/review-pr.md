# PRレビューコマンド（拡張版）

このPRを包括的にレビューして、建設的かつ実用的なフィードバックを提供してください。

## コードレビューの3つの目的

1. **🐛 短期的品質（バグの早期発見）**
   - ダブルチェックによるバグ・仕様漏れの発見
   - 発覚が遅くなるほどコストが増大（本番障害 > QA発見 > レビュー発見）
   - 例：「仕様に反しています」「このケースでエラーが起きませんか？」

2. **🏗️ 中長期的品質（内部品質の担保）**
   - 将来を見据えた設計・実装の確保
   - 保守性・拡張性・パフォーマンスの維持
   - 例：「N+1が発生します」「責務が混在しています」「命名が分かりにくい」

3. **📢 周知（チーム内の情報共有）**
   - 共通部分への変更の周知
   - 並行開発時の影響確認
   - 例：「共通コンポーネントを変更したので確認してください」

## レビュー依頼者の責任

### 必須：PR説明の充実化
1. **背景説明**
   - 何を解決しようとしているか明確に記載
   - Issue/チケット/設計ドキュメントへのリンク
   - 1年後の新メンバーが経緯を追えるか？

2. **レビュー観点の明示**
   - ✅ 周知だけで良いのか？
   - 🔍 不安な部分のダブルチェックが必要か？
   - 💭 命名やアーキテクチャの意見が欲しいか？
   - 特に確認してほしい箇所を明記

3. **先回りコメント（レビュワーの負担軽減）**
   - 「なぜこの実装にしたか」の理由と経緯（リンク付き）
   - 使用ライブラリ・メソッドへの1次情報リンク（バージョン付き）
   - 既存コードとの関連性（参考にしたファイルへのリンク）
   - 複雑なロジックの説明

4. **視覚的補助**
   - **Frontend**: UIコンポーネントごとのスクリーンショット
   - **Backend**: RSpec実行結果（`-f d`オプション付き）の貼り付け
   ```bash
   # RSpec実行結果の例
   bundle exec rspec spec/models/user_spec.rb -f d
   ```

## レビュー手順

### 1. **PR経緯の把握（必須）**
   ```bash
   # PRタイトル・説明・コメント履歴から背景と意図を理解
   gh pr view --json number,title,body,author,state,comments,reviews
   
   # PR作成者の意図・背景・解決したい課題を確認
   gh pr view --comments | head -50
   
   # 関連するIssueがある場合は内容確認
   gh pr view --json linkedIssues
   ```
   
   **重要**: 必ず以下を把握してからレビューを開始
   - PRの目的・解決しようとしている問題
   - なぜこの実装方法を選択したか
   - 議論された代替案や制約事項
   - PR作成者が特に確認してほしい点

### 2. **自動情報収集**
   ```bash
   # PR基本情報の取得
   gh pr view --json number,title,body,author,state,files,additions,deletions,commits
   
   # 変更内容の詳細確認
   gh pr diff
   
   # CI/CDステータス確認
   gh pr checks
   
   # 既存のレビューコメント確認
   gh api repos/{owner}/{repo}/pulls/{pr}/reviews --jq '.[].state' | sort | uniq -c
   
   # ファイル変更統計
   git diff --stat origin/main...HEAD
   ```

### 3. **自動セキュリティチェック**
   ```bash
   # 秘密情報の検出（可能な場合）
   git diff origin/main...HEAD | grep -E "(password|secret|token|api[_-]?key)" -i
   
   # ハードコードされた認証情報のチェック
   git diff origin/main...HEAD | grep -E "(['\"])([A-Za-z0-9+/]{40,}|sk_live_[A-Za-z0-9]+|ghp_[A-Za-z0-9]+)(['\"])"
   ```

### 4. **評価観点（3つの目的を意識）**

#### 🐛 短期的品質の観点
   - 🔒 **セキュリティ**: 認証・認可、機密情報露出、入力検証、OWASP Top 10
   - 🎯 **仕様準拠**: 要件との整合性、エッジケースの考慮、エラーハンドリング
   - ⚠️ **バグリスク**: 明らかなバグ、ロジックエラー、境界値の扱い

#### 🏗️ 中長期的品質の観点
   - ⚡ **パフォーマンス**: クエリ効率、リソース使用量、スケーラビリティ、N+1問題
   - 🏗️ **アーキテクチャ**: 設計品質、保守性、拡張性、SOLID原則、責務分割
   - ✨ **コード品質**: 可読性、命名規則、テスト充実度、DRY原則、見通しの良さ
     - 🔍 **重複コード検出**:
       - 同じロジックの多重定義（3回以上の繰り返し）
       - 共通処理として切り出すべきパターン
       - ヘルパー関数/ユーティリティクラスへの抽出可能性
       - 定数・設定値のハードコーディング（マジックナンバー/文字列）
     - 📝 **不必要なコメント**:
       - コードで自明な内容を説明するコメント
       - 古くなったTODOコメント（期限切れ、担当者不在）
       - コメントアウトされた不要なコード（git履歴で十分）
       - 誤解を招く・実装と矛盾するコメント
     - 🎯 **関数/メソッドの複雑度**:
       - 長すぎる関数（50行以上）→ 責務ごとに分割
       - ネストの深さ（3階層以上）→ 早期リターン・ガード節の活用
       - 引数が多すぎる（5個以上）→ オブジェクトにまとめる
       - 責務の混在（ビジネスロジック+UI制御など）→ レイヤー分離
   - 🔄 **運用性**: ログ出力、監視可能性、ロールバック容易性、将来の拡張性

#### 📢 周知の観点
   - 📝 **影響範囲**: 他チーム・機能への影響、共通部分の変更
   - 🔗 **依存関係**: 外部サービス・ライブラリへの依存、Breaking Changes

## フィードバック分類

各指摘には以下の分類を使用：

- 🔴 **critical.must**: 致命的な問題（セキュリティ脆弱性、データ損失リスク）
- 🟡 **high.imo**: 重要な改善（パフォーマンス問題、設計上の課題）
- 🟢 **medium.imo**: 中程度の改善（保守性、可読性の向上）
- 🟢 **low.nits**: 軽微な提案（スタイル、命名規則）
- 🔵 **info.q**: 質問・情報確認（実装意図、要件確認）

## 出力フォーマット

```markdown
## 📊 総合評価: X/10点

## 📈 変更サマリー
- **ファイル数**: X files changed
- **変更行数**: +XXX lines / -XXX lines  
- **コミット数**: X commits
- **CI/CDステータス**: ✅ All checks passed / ❌ X checks failed

## 📝 概要
### PR作成者の意図
PRタイトル・説明・コメントから把握した背景と目的の要約

### 変更の全体像
変更の目的と全体像の説明（1-2段落）

## 🔍 詳細レビュー

### 🔴 Critical Issues (critical.must)
セキュリティ脆弱性、データ損失リスク、本番障害の可能性
```diff
@@ file.ts:45 @@
- 問題のあるコード
+ 修正案
```
**理由**: 具体的な問題説明
**修正方法**: ステップバイステップの修正手順

### 🟡 High Priority (high.imo) 
パフォーマンス問題、設計上の重要な課題
- **[ファイル:行番号]** 具体的な改善提案と理由

### 🟢 Medium Priority (medium.imo)
保守性、可読性、テスタビリティの向上
- **[ファイル:行番号]** 改善提案

### 🟢 Minor Suggestions (low.nits)
スタイル、命名規則、コメント
- 軽微な提案のリスト

### 🔵 Questions (info.q)
実装意図の確認、要件の明確化
- 質問事項

## ✅ 良い実装
称賛すべき点、他のプロジェクトでも参考になる実装
- 具体的に良かった点とその理由

## 🎯 影響範囲分析
### 直接的な影響
- 変更されるAPI/機能のリスト

### 間接的な影響
- 依存する他のサービス/機能への影響

### Breaking Changes
- [ ] なし
- [ ] あり（詳細: XXX）

## ⚠️ リスク評価
### 技術的リスク
- パフォーマンス劣化の可能性: Low/Medium/High
- 後方互換性の問題: なし/あり
- スケーラビリティへの影響: なし/あり

### 運用上のリスク
- ロールバック難易度: Easy/Medium/Hard
- 監視/アラートの追加必要性: 不要/必要

## 📋 チェックリスト
- [ ] テストカバレッジは十分か
- [ ] エラーハンドリングは適切か
- [ ] ログ出力は適切か
- [ ] ドキュメントは更新されているか
- [ ] マイグレーションは必要か
- [ ] Feature Flagは必要か

## 👥 人間確認事項
ビジネスロジックや要件の妥当性確認が必要な部分
- 確認が必要な項目のリスト

## 💡 追加提案
このPRの範囲外だが、将来的に検討すべき改善点
- 中長期的な改善提案
```

## 評価基準

- **10点**: 完璧、ベストプラクティス完全準拠
- **8-9点**: 軽微な改善のみ、デプロイ可能
- **6-7点**: いくつかの改善必要、大きな問題なし
- **4-5点**: 重要な修正必要、再レビュー推奨
- **3点以下**: 大幅な見直し必要

## レビュー原則

### ✅ Do（レビュワーがフォーカスすべきこと）
- **文脈理解**: PR作成者の意図と背景を十分に理解してからレビュー
- **建設的**: 改善提案として伝える
- **具体的**: 修正方法や代替案を提示
- **教育的**: 学習機会として共有
- **称賛的**: 良い実装は積極的に評価
- **共感的**: 制約や経緯を考慮した現実的な提案
- **本質重視**: 責務分割・ファイル分割・メソッドの見通しの良さに注力
- **抽象→具体**: 「目次→本文」「概要→詳細」の構造を評価

### ❌ Don't（レビュワーが原則やらなくて良いこと）
- PRの背景を理解せずに批判
- 批判的・否定的な表現
- 曖昧で実行困難な指摘
- 重要度の説明なし
- 個人的好みに基づく要求
- 既に議論済みの内容を蒸し返す
- **動作確認**: ローカルでの詳細な動作確認（PR作成者の責任）
- **細かい記法の指摘**: 意見が分かれる記法（#select vs #filter、早期リターンなど）
  - 労力に対してメリットが小さい
  - メンバー変更で基準が変わりうる
  - 見通しの良さの方が重要
- **FrontendのUI詳細確認**: デザイナー/PdMの責任範囲
  - ただしロジック部分はしっかり確認
  - スクリーンショットで概要確認は有用
- **RSpecの詳細確認**: ざっと眺める程度で十分
  - `-f d`付き実行結果があれば理解が捗る

## 技術スタック別の観点

### フロントエンド
- パフォーマンス最適化（バンドルサイズ、レンダリング効率）
- アクセシビリティ（WCAG準拠、キーボード操作）
- レスポンシブデザイン、クロスブラウザ対応
- 状態管理の適切性

### バックエンド  
- API設計（RESTful/GraphQL原則）
- エラーハンドリング、リトライ戦略
- データベース設計、クエリ最適化
- 並行性制御、トランザクション管理

### インフラ・DevOps
- リソース効率性、コスト最適化
- 監視・ロギング戦略
- 障害復旧計画、冗長性
- セキュリティ設定（IAM、ネットワーク）

## 自動化されたアクション

### レビュー結果のGitHub投稿
```bash
# レビュー結果をPRにコメントとして投稿
gh pr comment {pr_number} --body "レビュー結果"

# 重要な問題がある場合は変更要求
gh pr review {pr_number} --request-changes --body "修正が必要です"

# 問題がない場合は承認
gh pr review {pr_number} --approve --body "LGTMです"
```

### 自動ラベル付与
```bash
# 優先度に応じたラベル付与
gh pr edit {pr_number} --add-label "needs-security-review"  # Critical issue
gh pr edit {pr_number} --add-label "performance-improvement" # Performance issue
gh pr edit {pr_number} --add-label "ready-to-merge"         # No issues
```

## 効率的なレビューのコツ

### レビュー前の確認
1. **PR作成者の責任を確認**: 背景説明・先回りコメントが十分か
2. **レビュー観点の把握**: 何を重点的に見るべきか明確にする
3. **時間配分の決定**: 周知なら軽く、設計レビューなら重点的に

### レビュー実施時
1. **本質に集中**: 責務分割・見通しの良さ・拡張性を最優先
2. **差分に集中**: 変更された部分のみをレビュー対象とする
3. **パターン認識**: よくある問題パターンを最初にチェック
4. **段階的レビュー**: Critical → High → Medium → Low の順で確認
5. **建設的フィードバック**: 問題点だけでなく改善案も必ず提示
6. **学習機会の提供**: なぜその実装が問題なのかを説明

### コスト意識
- **細かい記法 < 見通しの良さ**: 記法統一より構造改善に注力
- **労力対効果**: 得られるメリットと必要な労力のバランスを考慮
- **チーム効率**: レビュワーとPR作成者双方の時間を尊重

レビューを開始してください。包括的で建設的なフィードバックをお願いします。