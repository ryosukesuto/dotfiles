# /review-pr - 体系的なPRレビュー

このPRを体系的にレビューし、実行可能なフィードバックを提供してください。

## コードレビューの目的

コードレビューは以下の3つの目的を持ちます：

1. **🐛 バグの早期発見** - 本番障害を防ぐダブルチェック
2. **🏗️ 品質の担保** - 将来を見据えた保守性・拡張性の確保
3. **📢 情報共有** - チーム内での変更の周知と影響確認

## レビュー原則

### 報告基準

優先度の高い問題から報告。以下の基準で判断：

1. **離散的で実行可能** - 明確な修正アクションが存在する
2. **PRで発生または顕在化** - このPRで新規導入、または既存問題を悪化させる変更
3. **修正コストと価値のバランス** - 修正の手間に対して、得られる改善効果が見合う
4. **影響が明確** - 精度、パフォーマンス、セキュリティ、保守性のいずれかに影響

**注**: P0-P1問題は基準を緩めに適用。既存の潜在的問題でも、このPRで顕在化するなら報告推奨。

### フィードバックの特徴

#### 全体の原則
- **事実的**: 問題の理由を明確に説明、感情的表現を避ける
- **建設的**: 批判ではなく改善提案として伝える

#### 優先度別の記述レベル
- **P0-P1**: 問題・影響・修正案を必須記載（2-3文＋コード例推奨）
- **P2**: 提案・理由を簡潔に記載（1-2文、コード例は任意）
- **P3**: 簡潔な提案のみ（1文、詳細説明不要）

#### 良い点の評価
- 他の開発者の学習になる実装を**具体的に**称賛（ファイル:行番号付き）
- 過度な褒め言葉（"Nice!", "Great work!"）は避ける
- 学習価値のある良い実装がある場合は積極的に評価

### 避けるべきレビュー

- ❌ **曖昧な指摘** - 「もっと良くできる」（何をどう改善するか不明）
- ❌ **理由なし** - 「これは良くない」（なぜ良くないか説明なし）
- ❌ **既存の問題** - このPRで導入されていない問題
- ❌ **個人的好み** - チーム合意がない主観的スタイル指摘
- ❌ **過度な称賛** - 不必要な褒め言葉（"Nice!", "Great work!"）

## 優先度分類

各指摘には以下の優先度を明記：

### P0 (Blocking) - マージ前に必須
- セキュリティ脆弱性（認証/認可、SQLi、XSS、CSRF）
- データ損失リスク（削除、破壊的変更）
- 重大なバグ（クラッシュ、機能停止）
- 本番障害の直接原因となる問題
- **APIの破壊的変更**（互換性崩壊、即時障害のリスク）

### P1 (Urgent) - 次のサイクルで対応
- パフォーマンス問題（N+1クエリ、メモリリーク）
- 重要なエラーハンドリング不足
- テストカバレッジの欠如（重要な機能）

### P2 (Normal) - いずれ修正
- 設計上の改善（責務分離、拡張性）
- 保守性の向上（重複コード、複雑な関数）
- ドキュメント不足
- 軽微なバグリスク

### P3 (Low) - 余裕があれば
- 命名規則の改善
- コメントの追加・削除
- コードスタイルの統一
- 軽微なリファクタリング

## レビュー実施手順（Claude Codeへの指示）

このコマンドを実行したあなた（Claude Code）は、以下の手順でPRレビューを実施してください。

### ステップ1: コンテキスト把握

PRの背景と意図を理解するため、以下を実行：

```bash
# PRの基本情報とコメント履歴を確認
gh pr view --comments

# 変更内容の確認
gh pr diff

# CI/CDステータスの確認
gh pr checks
```

**必ず把握すべき情報**：
- PRの目的と解決しようとしている問題
- 既に議論されたコメント内容と決定事項
- PR作成者が特に確認してほしい点
- 既存のレビュー指摘と対応状況

### ステップ2: Codex分析の実施（推奨）

Codex CLIを使用してPRの初期分析を取得。Codex自身がghコマンドを実行できるため、シンプルに依頼：

```bash
# Codexに直接PRレビューを依頼（タイムアウト5分推奨）
codex exec "このPRをレビューしてください。

## 手順
1. gh pr view --comments でPRの背景・目的・既存コメントを確認
2. gh pr diff でPR差分を確認
3. 以下の観点でレビュー実施

## レビュー観点と優先度
以下の優先度（P0-P3）で問題を分類し、報告してください：

- **P0 (Blocking)**: マージ前に必須の修正（セキュリティ脆弱性、データ損失、重大なバグ、API破壊的変更）
- **P1 (Urgent)**: 次のサイクルで対応（パフォーマンス問題、エラーハンドリング不足、テスト不足）
- **P2 (Normal)**: いずれ修正（設計改善、保守性向上、ドキュメント不足）
- **P3 (Low)**: 余裕があれば（命名規則、スタイル、軽微なリファクタリング）

## 出力形式
各指摘は以下の形式で簡潔に（1-2文＋修正方法）：

### [PX] file:line - 問題の要約
**問題**: 何が問題か
**影響**: なぜ重要か
**修正案**: 具体的な改善方法
"
```

**大規模PR（300行以上）の場合**：
```bash
# PR規模を事前確認
CHANGED_LINES=$(gh pr diff --stat | tail -1 | awk '{print $4+$6}')

if [[ $CHANGED_LINES -gt 300 ]]; then
  echo "⚠️ 大規模PR（${CHANGED_LINES}行）のため、Codex分析に時間がかかる可能性があります。"
  echo "分割レビューを推奨します。"
fi
```

**Codex分析結果の扱い**：
- AI分析は参考情報として扱い、最終判断はあなた（Claude Code）が行う
- False Positive（AI誤検知）を検証・除外
- プロジェクト固有の文脈・制約を考慮して優先度を調整
- AIが見逃しやすい観点（要件適合性、ビジネスロジック）を補完

### ステップ3: 体系的な評価

Codex分析結果を参考にしつつ、以下の観点でPRを評価：

#### 🔒 セキュリティ（P0優先）
- [ ] 認証・認可ロジックの実装が適切か
- [ ] 入力検証が全てのエンドポイントで実装されているか
- [ ] 機密情報（パスワード、APIキー、トークン）がハードコードされていないか
- [ ] SQLインジェクション、XSS、CSRFなどの脆弱性がないか

#### ⚡ パフォーマンス（P1優先）
- [ ] N+1クエリ問題がないか（eager loading、バッチ処理）
- [ ] 非効率なアルゴリズム（O(n²)以上）が使用されていないか
- [ ] データベースインデックスが適切に設定されているか
- [ ] キャッシュ戦略が適切か

#### 🎯 正確性（P0-P1）
- [ ] PRの目的と実装内容が一致しているか
- [ ] エッジケース（空配列、null、エラー時）の処理が実装されているか
- [ ] エラーハンドリングが適切か
- [ ] 既存機能への影響がないか

#### 🏗️ 保守性（P2優先）
- [ ] 責務分離が適切か（単一責任原則）
- [ ] 関数が適切な長さか（50行以内を目安）
- [ ] ネストが深すぎないか（3階層以内）
- [ ] 重複コードがないか（3回以上の繰り返しは共通化）
- [ ] 変数・関数名が意図を明確に表現しているか

#### 📝 テスト（P1-P2）
- [ ] 適切なテストが実装されているか
- [ ] エッジケースのテストがあるか
- [ ] テストカバレッジが十分か

### ステップ4: 統合レビューの作成

**重要**: Codex分析とあなた自身の評価を統合し、一つのレビューとして提示してください。

#### 統合の原則
- Codex指摘を鵜呑みにせず、必ず妥当性を検証
- False Positive（AI誤検知）は除外
- プロジェクト固有の文脈・制約を考慮して優先度を調整
- AIが見逃した観点（要件適合性、ビジネスロジック）を補完
- 最終的なレビュー内容はあなたが責任を持って決定

#### AI + Claude Codeのハイブリッドレビュー
- **Codex得意領域**: セキュリティ脆弱性、パフォーマンス問題、コーディング規約
- **あなた重視領域**: 要件適合性、設計判断、ビジネスロジック、チーム規約
- **出力**: AIと人間を分けず、統合された一つのレビューとして提示

## 出力フォーマット

### 必須セクション（すべてのPRで記載）

```markdown
## 📊 レビュー結果

**変更内容**: X files (+XXX/-XXX lines) | CI: ✅ Pass / ❌ Fail
**総合評価**: X/10点

### 概要
PRの目的と変更内容を1-2文で要約。

---

## 🎯 レビューステータス

- [ ] 🔴 変更要求（P0項目の修正後に再レビュー）
- [ ] 🟡 承認保留（質問への回答待ち）
- [ ] 🟢 承認（LGTM - マージ可能）
```

### 問題がある場合のセクション（優先度順）

```markdown
## 🔴 P0: マージ前に必須

### [file:line] 問題の要約
**問題**: 何が問題か（1-2文）
**影響**: セキュリティ/データ損失/本番障害のリスク
**修正案**: 具体的な修正方法
```lang
// 修正例のコード
```

---

## 🟡 P1: 次のサイクルで対応

### [file:line] 問題の要約
**問題**: 何が問題か（1-2文）
**影響**: パフォーマンス/エラーハンドリング/テストの不足
**修正案**: 具体的な改善方法

---

## 🟢 P2: いずれ修正

### [file:line] 改善提案
**提案**: どう改善するか（1-2文）
**理由**: なぜ改善すべきか

---

## 💤 P3: 余裕があれば

- [file:line] 簡潔な提案（1文）
```

### 任意セクション（該当する場合のみ記載）

```markdown
## 💬 質問・確認

実装意図や要件の確認（はい/いいえで答えられる形式が望ましい）

---

## ✅ 良かった点

具体的に称賛すべき実装（他の開発者の参考になるもの）
- [file:line] 良い実装の理由を簡潔に説明

---

## ⚠️ 注意事項

- **Breaking Changes**: なし / あり（詳細）
- **ロールバック**: 容易 / 注意が必要 / 困難（理由）
- **モニタリング**: 不要 / 推奨（監視項目）

---

## 📋 アクションアイテム

### 必須（P0）
1. [具体的な修正内容] - 期限の目安

### 推奨（P1）
1. [改善提案] - 優先順位

### 任意（P2-P3）
1. [将来的な改善提案]
```

## 評価基準

総合評価の目安：

- **10点**: 完璧、ベストプラクティス完全準拠
- **8-9点**: 軽微な改善のみ、即座にマージ可能
- **6-7点**: いくつかの改善必要、大きな問題なし
- **4-5点**: 重要な修正必要、再レビュー推奨
- **3点以下**: 大幅な見直し必要、マージ不可

## レビュワーの心得

### レビューの目的

PR作成者が**次のアクションを明確に理解し、即座に実行できる**フィードバックを提供すること。

### 効果的なレビューの5原則

1. **実行可能性** - 具体的な修正方法を提示
2. **優先順位** - P0/P1/P2/P3で重要度を明確化
3. **理由の説明** - なぜその修正が必要か技術的根拠を示す
4. **簡潔さ** - 各コメントは1パラグラフ以内
5. **建設的** - 問題点だけでなく、良い実装があれば評価

### レビューワークフロー

1. **コンテキスト把握** → PRの背景・意図・既存コメントを理解
2. **体系的分析** → セキュリティ → 正確性 → パフォーマンス → 保守性の順で評価
3. **優先度判断** → P0（必須）→ P1（推奨）→ P2-P3（任意）に分類
4. **具体的提案** → 修正方法とコード例を提示
5. **前向き評価** → 学習価値のある良い実装があれば言及

## 技術スタック別の観点

### フロントエンド
- パフォーマンス（バンドルサイズ、レンダリング効率、不要な再レンダリング）
- アクセシビリティ（WCAG準拠、キーボード操作、スクリーンリーダー対応）
- レスポンシブデザイン、クロスブラウザ対応
- 状態管理の適切性（Redux/Context/Zustand）

### バックエンド
- API設計（RESTful/GraphQL原則、バージョニング）
- エラーハンドリング（適切なHTTPステータス、リトライ戦略）
- データベース設計（正規化、インデックス、クエリ最適化）
- 並行性制御（トランザクション、ロック、デッドロック回避）

### インフラ・DevOps
- リソース効率性（コスト最適化、自動スケーリング）
- 監視・ロギング（メトリクス、アラート、ログ集約）
- 障害復旧（バックアップ、冗長性、災害対策）
- セキュリティ設定（IAM、ネットワーク、暗号化）

## 効率的なレビューのコツ

### タイムボックス

- **小規模PR（<100行）**: 10-15分
- **中規模PR（100-300行）**: 20-30分
- **大規模PR（300行+）**: 45-60分、または分割レビューを提案

### 集中すべき観点

1. **セキュリティ（5分）**: 脆弱性、機密情報露出を最優先チェック
2. **正確性（10分）**: ロジックエラー、エッジケース、エラーハンドリング
3. **パフォーマンス（5分）**: N+1、非効率なアルゴリズム、リソース使用
4. **保守性（10分）**: 設計、可読性、テスト、ドキュメント

### レビュー品質のセルフチェック

レビュー完了時に以下を確認：

- ✅ PR作成者が次に何をすべきか明確か？
- ✅ 各指摘に理由と修正方法が含まれているか？
- ✅ 優先度（P0-P3）が適切に設定されているか？
- ✅ 建設的で前向きなトーンか？
- ✅ プロジェクトの文脈と制約を考慮しているか？

---

## 実行指示（Claude Codeへ）

あなた（Claude Code）は、このコマンドを読み込んだら**即座に以下を実行**してください：

### 1. PR情報の取得
```bash
# PRの基本情報とコメントを確認
gh pr view --comments

# 変更差分を確認
gh pr diff

# CI/CDステータスを確認
gh pr checks
```

### 2. Codex分析の実施（推奨）
```bash
# Codexに初期分析を依頼
codex exec "このPRをレビューしてください。

## 手順
1. gh pr view --comments でPRの背景・目的・既存コメントを確認
2. gh pr diff でPR差分を確認
3. 以下の観点でレビュー実施

## レビュー観点と優先度
以下の優先度（P0-P3）で問題を分類し、報告してください：

- **P0 (Blocking)**: マージ前に必須の修正（セキュリティ脆弱性、データ損失、重大なバグ、API破壊的変更）
- **P1 (Urgent)**: 次のサイクルで対応（パフォーマンス問題、エラーハンドリング不足、テスト不足）
- **P2 (Normal)**: いずれ修正（設計改善、保守性向上、ドキュメント不足）
- **P3 (Low)**: 余裕があれば（命名規則、スタイル、軽微なリファクタリング）

## 出力形式
各指摘は以下の形式で簡潔に（1-2文＋修正方法）：

### [PX] file:line - 問題の要約
**問題**: 何が問題か
**影響**: なぜ重要か
**修正案**: 具体的な改善方法
"
```

### 3. 統合レビューの作成

Codex分析結果とあなた自身の評価を統合し、**上記の出力フォーマットに従って**一つのレビューとして提示してください。

#### 重要な原則
- **統合**: Codexと人間を分けず、一つの統一されたレビューとして出力
- **検証**: Codex指摘の妥当性を必ず検証（False Positive除外）
- **補完**: AIが見逃した観点（要件適合性、ビジネスロジック）を補完
- **責任**: 最終的なレビュー内容はあなたが決定

PR作成者が即座にアクションを取れる、実用的で建設的なフィードバックを提供してください。
