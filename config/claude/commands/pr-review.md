# PRレビューコマンド（拡張版）

このPRを包括的にレビューして、建設的かつ実用的なフィードバックを提供してください。

## レビュー手順

### 1. **PR経緯の把握（必須）**
   ```bash
   # PRタイトル・説明・コメント履歴から背景と意図を理解
   gh pr view --json number,title,body,author,state,comments,reviews
   
   # PR作成者の意図・背景・解決したい課題を確認
   gh pr view --comments | head -50
   
   # 関連するIssueがある場合は内容確認
   gh pr view --json linkedIssues
   ```
   
   **重要**: 必ず以下を把握してからレビューを開始
   - PRの目的・解決しようとしている問題
   - なぜこの実装方法を選択したか
   - 議論された代替案や制約事項
   - PR作成者が特に確認してほしい点

### 2. **自動情報収集**
   ```bash
   # PR基本情報の取得
   gh pr view --json number,title,body,author,state,files,additions,deletions,commits
   
   # 変更内容の詳細確認
   gh pr diff
   
   # CI/CDステータス確認
   gh pr checks
   
   # 既存のレビューコメント確認
   gh api repos/{owner}/{repo}/pulls/{pr}/reviews --jq '.[].state' | sort | uniq -c
   
   # ファイル変更統計
   git diff --stat origin/main...HEAD
   ```

### 3. **自動セキュリティチェック**
   ```bash
   # 秘密情報の検出（可能な場合）
   git diff origin/main...HEAD | grep -E "(password|secret|token|api[_-]?key)" -i
   
   # ハードコードされた認証情報のチェック
   git diff origin/main...HEAD | grep -E "(['\"])([A-Za-z0-9+/]{40,}|sk_live_[A-Za-z0-9]+|ghp_[A-Za-z0-9]+)(['\"])"
   ```

### 4. **5つの観点で評価**
   - 🔒 **セキュリティ**: 認証・認可、機密情報露出、入力検証、OWASP Top 10
   - ⚡ **パフォーマンス**: クエリ効率、リソース使用量、スケーラビリティ、N+1問題
   - 🏗️ **アーキテクチャ**: 設計品質、保守性、拡張性、SOLID原則
   - ✨ **コード品質**: 可読性、命名規則、テスト充実度、DRY原則
   - 🔄 **運用性**: ログ出力、エラーハンドリング、監視可能性、ロールバック容易性

## フィードバック分類

各指摘には以下の分類を使用：

- 🔴 **critical.must**: 致命的な問題（セキュリティ脆弱性、データ損失リスク）
- 🟡 **high.imo**: 重要な改善（パフォーマンス問題、設計上の課題）
- 🟢 **medium.imo**: 中程度の改善（保守性、可読性の向上）
- 🟢 **low.nits**: 軽微な提案（スタイル、命名規則）
- 🔵 **info.q**: 質問・情報確認（実装意図、要件確認）

## 出力フォーマット

```markdown
## 📊 総合評価: X/10点

## 📈 変更サマリー
- **ファイル数**: X files changed
- **変更行数**: +XXX lines / -XXX lines  
- **コミット数**: X commits
- **CI/CDステータス**: ✅ All checks passed / ❌ X checks failed

## 📝 概要
### PR作成者の意図
PRタイトル・説明・コメントから把握した背景と目的の要約

### 変更の全体像
変更の目的と全体像の説明（1-2段落）

## 🔍 詳細レビュー

### 🔴 Critical Issues (critical.must)
セキュリティ脆弱性、データ損失リスク、本番障害の可能性
```diff
@@ file.ts:45 @@
- 問題のあるコード
+ 修正案
```
**理由**: 具体的な問題説明
**修正方法**: ステップバイステップの修正手順

### 🟡 High Priority (high.imo) 
パフォーマンス問題、設計上の重要な課題
- **[ファイル:行番号]** 具体的な改善提案と理由

### 🟢 Medium Priority (medium.imo)
保守性、可読性、テスタビリティの向上
- **[ファイル:行番号]** 改善提案

### 🟢 Minor Suggestions (low.nits)
スタイル、命名規則、コメント
- 軽微な提案のリスト

### 🔵 Questions (info.q)
実装意図の確認、要件の明確化
- 質問事項

## ✅ 良い実装
称賛すべき点、他のプロジェクトでも参考になる実装
- 具体的に良かった点とその理由

## 🎯 影響範囲分析
### 直接的な影響
- 変更されるAPI/機能のリスト

### 間接的な影響
- 依存する他のサービス/機能への影響

### Breaking Changes
- [ ] なし
- [ ] あり（詳細: XXX）

## ⚠️ リスク評価
### 技術的リスク
- パフォーマンス劣化の可能性: Low/Medium/High
- 後方互換性の問題: なし/あり
- スケーラビリティへの影響: なし/あり

### 運用上のリスク
- ロールバック難易度: Easy/Medium/Hard
- 監視/アラートの追加必要性: 不要/必要

## 📋 チェックリスト
- [ ] テストカバレッジは十分か
- [ ] エラーハンドリングは適切か
- [ ] ログ出力は適切か
- [ ] ドキュメントは更新されているか
- [ ] マイグレーションは必要か
- [ ] Feature Flagは必要か

## 👥 人間確認事項
ビジネスロジックや要件の妥当性確認が必要な部分
- 確認が必要な項目のリスト

## 💡 追加提案
このPRの範囲外だが、将来的に検討すべき改善点
- 中長期的な改善提案
```

## 評価基準

- **10点**: 完璧、ベストプラクティス完全準拠
- **8-9点**: 軽微な改善のみ、デプロイ可能
- **6-7点**: いくつかの改善必要、大きな問題なし
- **4-5点**: 重要な修正必要、再レビュー推奨
- **3点以下**: 大幅な見直し必要

## レビュー原則

### ✅ Do
- **文脈理解**: PR作成者の意図と背景を十分に理解してからレビュー
- **建設的**: 改善提案として伝える
- **具体的**: 修正方法や代替案を提示
- **教育的**: 学習機会として共有
- **称賛的**: 良い実装は積極的に評価
- **共感的**: 制約や経緯を考慮した現実的な提案

### ❌ Don't
- PRの背景を理解せずに批判
- 批判的・否定的な表現
- 曖昧で実行困難な指摘
- 重要度の説明なし
- 個人的好みに基づく要求
- 既に議論済みの内容を蒸し返す

## 技術スタック別の観点

### フロントエンド
- パフォーマンス最適化（バンドルサイズ、レンダリング効率）
- アクセシビリティ（WCAG準拠、キーボード操作）
- レスポンシブデザイン、クロスブラウザ対応
- 状態管理の適切性

### バックエンド  
- API設計（RESTful/GraphQL原則）
- エラーハンドリング、リトライ戦略
- データベース設計、クエリ最適化
- 並行性制御、トランザクション管理

### インフラ・DevOps
- リソース効率性、コスト最適化
- 監視・ロギング戦略
- 障害復旧計画、冗長性
- セキュリティ設定（IAM、ネットワーク）

## 自動化されたアクション

### レビュー結果のGitHub投稿
```bash
# レビュー結果をPRにコメントとして投稿
gh pr comment {pr_number} --body "レビュー結果"

# 重要な問題がある場合は変更要求
gh pr review {pr_number} --request-changes --body "修正が必要です"

# 問題がない場合は承認
gh pr review {pr_number} --approve --body "LGTMです"
```

### 自動ラベル付与
```bash
# 優先度に応じたラベル付与
gh pr edit {pr_number} --add-label "needs-security-review"  # Critical issue
gh pr edit {pr_number} --add-label "performance-improvement" # Performance issue
gh pr edit {pr_number} --add-label "ready-to-merge"         # No issues
```

## 効率的なレビューのコツ

1. **差分に集中**: 変更された部分のみをレビュー対象とする
2. **パターン認識**: よくある問題パターンを最初にチェック
3. **段階的レビュー**: Critical → High → Medium → Low の順で確認
4. **建設的フィードバック**: 問題点だけでなく改善案も必ず提示
5. **学習機会の提供**: なぜその実装が問題なのかを説明

レビューを開始してください。包括的で建設的なフィードバックをお願いします。