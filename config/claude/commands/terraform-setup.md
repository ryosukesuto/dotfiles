# Terraform作業セットアップ

Terraformプロジェクトでの作業を開始する際の手順とチェックリストを実行します。

## 📋 作業内容の確認

まず、今回行う作業内容を教えてください：

- **何のリソースを変更しますか？** (例: BigQuery、Cloud Run、IAM等)
- **変更の目的は何ですか？** (例: 新規追加、設定変更、削除等)
- **緊急度はどの程度ですか？** (例: 通常作業、障害対応、緊急対応等)

作業内容を確認後、適切なセットアップガイダンスを提供します。

## 🚀 作業開始手順

### 1. 現在の状況確認
```bash
# 作業ブランチの確認
git branch --show-current

# 変更されるファイルの確認
git diff --name-only

# 未コミットの変更確認
git status
```

### 2. Sandboxブランチとの同期確認
```bash
# Sandboxブランチの最新状態を取得
git fetch origin sandbox

# 現在のブランチとSandboxの差分確認
git log --oneline sandbox..HEAD

# 必要に応じてSandboxブランチと同期
git rebase origin/sandbox
```

## 📋 作業前チェックリスト

以下の項目を確認してから作業を開始してください：

### ✅ 環境・権限確認
- [ ] 適切なGCPプロジェクトに接続されている
- [ ] Terraform用のサービスアカウント権限が有効
- [ ] 作業対象の環境（dev/staging/prod）を確認

### ✅ コード変更準備
- [ ] 変更予定のリソースを特定
- [ ] 影響を受ける下流システムを把握
- [ ] 必要なドキュメント更新箇所を洗い出し

### ✅ 安全確認
- [ ] 本番環境への影響がないことを確認
- [ ] バックアップやロールバック手順を確認
- [ ] セキュリティ・コンプライアンス要件をチェック

## 🛠️ 作業中のベストプラクティス

### コード変更時の同時作業
1. **variables.tf変更** → 説明とデフォルト値を即座に文書化
2. **outputs.tf変更** → 用途と使用例を記載
3. **README.md更新** → リソース構成図を同時更新
4. **セキュリティ変更** → IAM権限とセキュリティ考慮事項を記載

### 段階的な進め方
- 小さな変更単位で進める
- 各変更後にドキュメントを更新
- 依存関係のあるリソースは順序を考慮

## 📝 作業完了時のチェック

### PR作成前の最終確認
```bash
# Terraformファイルのフォーマット（CIエラー回避）
terraform fmt -recursive

# 構文検証
terraform validate

# 変更ファイルの最終確認
git diff --name-only
```

### ✅ ドキュメント更新確認
- [ ] variables.tf/outputs.tfの説明が最新
- [ ] README.mdのリソース構成図が更新済み
- [ ] 環境別設定の差異が文書化済み
- [ ] セキュリティ・コスト影響が記載済み

### ✅ PR準備確認
- [ ] Sandboxブランチと同期済み
- [ ] コミットメッセージが適切
- [ ] 変更の影響範囲を説明できる
- [ ] 環境別の設定差異を把握

## 🎯 重要な制約事項

### GitOpsワークフロー厳守
- ❌ **禁止**: `terraform apply`のローカル実行
- ❌ **禁止**: 状態ファイルの手動操作
- ✅ **推奨**: CI/CDパイプライン経由での変更

### セキュリティ考慮
- 機密情報のハードコーディング禁止
- IAM権限の最小限の原則を遵守
- リソース削除時は影響範囲を十分検証

## 📋 関連コマンド

作業完了後のPRレビューには以下を使用：
```
/user:review-pr
```

---

Terraform作業の準備が整いましたか？上記の手順とチェックリストに従って安全に作業を進めてください。